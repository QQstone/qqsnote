---
title: DevOps-Database
date: 2021-09-23 09:52:26
tags:
- DevOps
categories: 
- 数据库
---
参考[数据迁移，不停机上线的正确姿势](https://cloud.tencent.com/developer/article/1740904)
#### staging slot 切换
新建staging库，从旧数据库同步数据，同步数据结束后在空闲时段停服，将流量切换至新库

#### 不停机
1. 准备新库 表结构更新或分库分表操作
2. 开启双写，服务端同时向新老两个库写入数据 此阶段需要联查历史数据进行写入的操作可以先查老数据库 再写入新库
3. 双写过程中，开始历史数据迁移，将某一时间点的历史数据迁移到新库，迁移范围要覆盖到双写数据范围以避免数据遗漏
4. 数据校验，确认没有遗漏 以及写入失败的个别情况
5. 开启双读，流量逐步过渡到新库
6. 关闭老库写功能
7. 删除双写双读等业务无关逻辑