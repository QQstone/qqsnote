<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/qqsnote/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/qqsnote/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/qqsnote/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/qqsnote/images/logo.svg" color="#222">

<link rel="stylesheet" href="/qqsnote/css/main.css">


<link rel="stylesheet" href="/qqsnote/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qqstone.github.io","root":"/qqsnote/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="QQs&#39;Note">
<meta property="og:url" content="http://qqstone.github.io/qqsnote/page/21/index.html">
<meta property="og:site_name" content="QQs&#39;Note">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="QQs">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://qqstone.github.io/qqsnote/page/21/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>QQs'Note</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/qqsnote/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">QQs'Note</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/qqsnote/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/qqsnote/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qqstone.github.io/qqsnote/2020/07/20/Common-Auth-Methods/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/qqsnote/images/avatar.gif">
      <meta itemprop="name" content="QQs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QQs'Note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/qqsnote/2020/07/20/Common-Auth-Methods/" class="post-title-link" itemprop="url">常见认证授权方式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-20 10:28:58" itemprop="dateCreated datePublished" datetime="2020-07-20T10:28:58+08:00">2020-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-05 10:07:52" itemprop="dateModified" datetime="2025-07-05T10:07:52+08:00">2025-07-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/qqsnote/categories/%E5%8D%8F%E8%AE%AE%E5%92%8C%E8%A7%84%E8%8C%83/" itemprop="url" rel="index"><span itemprop="name">协议和规范</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考<a target="_blank" rel="noopener" href="https://www.lishuaishuai.com/nodejs/1167.html?soure=jj">前后端常见的几种鉴权方式</a></p>
<h4 id="Basic-Authentication"><a href="#Basic-Authentication" class="headerlink" title="Basic Authentication"></a>Basic Authentication</h4>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qqstone.github.io/qqsnote/2020/07/17/AZ900/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/qqsnote/images/avatar.gif">
      <meta itemprop="name" content="QQs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QQs'Note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/qqsnote/2020/07/17/AZ900/" class="post-title-link" itemprop="url">AZ900</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-17 10:30:43" itemprop="dateCreated datePublished" datetime="2020-07-17T10:30:43+08:00">2020-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-12-04 15:19:52" itemprop="dateModified" datetime="2025-12-04T15:19:52+08:00">2025-12-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/qqsnote/categories/%E4%BA%91%E5%B9%B3%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">云平台</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>订阅  付费边界 访问管理策略的边界<br>影响成本的因素：资源类型 服务 位置<br>pricing carculator 产品定价计算器和总拥有成本计算器<br>降低成本：</p>
<ul>
<li>执行成本分析</li>
<li>使用Azure顾问监视使用情况</li>
<li>使用支出限制</li>
<li>使用Azure预订 提前付款产品</li>
<li>选择低成本地点和地区</li>
<li>使用标签标识成本所有者<br>cost manage工具<br>改进应用程序SLA 承诺的性能目标 如某级别月累计停机时间不超过xxx</li>
</ul>
<h4 id="云计算概览"><a href="#云计算概览" class="headerlink" title="云计算概览"></a>云计算概览</h4><p><img src="https://docs.microsoft.com/zh-cn/learn/modules/principles-cloud-computing/media/2-vm-vs-container-vs-serverless.png" alt=""></p>
<blockquote>
<p>自称：经济高效、可缩放、具有弹性、始终保持最新状态、可靠且安全</p>
</blockquote>
<ul>
<li>资本支出 (Capital Expenditure, CapEx)实体基础设施投入费用, 如服务器、存储、网络、备份、灾后重建、技术人员</li>
<li>运营支出 (Operational Expenditure, OpEx) 服务/产品使用费用<br> </li>
</ul>
<blockquote>
<p>issue: 测试从Azure Serveice 到 remote DB server的network connections<br>背景：老板要将正在开发的项目放到公网可以访问的服务器上以用来演示，迁移数据库到云端是费事且有额外成本的。</p>
</blockquote>
<pre><code>日前的实践找到了控制台的解决方法 创建App Service后其管理面板上Development Tools--SSH，其进入后是linux终端，路径在wwwroot下，常用网络连接工具见&#123;% post-link LinuxTools Linux命令行工具 %&#125; curl命令可用
</code></pre><h4 id="benefit"><a href="#benefit" class="headerlink" title="benefit"></a>benefit</h4><p>The public cloud is a shared entity whereby multiple corporations each use a portion of the resources in the cloud. It is the benefit of using a public cloud service for the servers over an on-premises network</p>
<h4 id="混合云（Hybrid-Cloud）"><a href="#混合云（Hybrid-Cloud）" class="headerlink" title="混合云（Hybrid Cloud）"></a>混合云（Hybrid Cloud）</h4><p>公有云的缺点：使用公有云可能无法满足特定的安全要求；公有云可能无法满足政府政策、行业标准或法律要求；不拥有硬件或服务，也无法按照你的意愿管理它们；可能很难满足独特的业务需求，例如必须维护旧版应用程序</p>
<p>私有云服务和公有云服务的结合，即要架设开放的商用应用，又对部分资源存在硬件或自主管理方面的要求，宜选择私有云<br><br>例题：Suppose you have two types of applications: legacy applications that require specialized mainframe hardware and newer applications that can run on commodity hardware. Which cloud deployment model would be best for you?<br><br>A. Public cloud<br>B. Private cloud<br>C. Hybrid cloud</p>
<p>保留预置的(on-premise)服务器，并且扩展需求，宜选择混合云，即保留原服务器以消除迁移成本，且用公有平台（或其他资源）进行方便的扩展</p>
<p>例题：You have an on-premises network that contains 100 servers.<br>You need to recommend a solution that provides additional resources to your users. The solution must minimize capital and operational expenditure costs.<br><br>A. a complete migration to the public cloud<br>B. an additional data center<br>C. a private cloud<br>D. a hybrid cloud  </p>
<p>极具<a target="_blank" rel="noopener" href="https://www.examtopics.com/discussions/microsoft/view/5732-exam-az-900-topic-1-question-5-discussion/">争议</a>的一道判断题：An organization that hosts its infrastructure in a private cloud can decommission its data center.<br><br>答案是False. 希望不要在考场上遇到这么坑爹的表述，题干问如果organization在私有云上架设自己的设施，那他自己数据中心是不可或缺的还是可以decommission（拆除），其想表达的是如果你用公有云或者混合云，就没有必要自己经营数据中心了。</p>
<h4 id="IaaS-PaaS-SaaS"><a href="#IaaS-PaaS-SaaS" class="headerlink" title="IaaS PaaS SaaS"></a>IaaS PaaS SaaS</h4><p>Infrastructure as a service (IaaS) is an instant computing infrastructure, provisioned and managed over the internet. It’s one of the four types of cloud services, along with software as a service (SaaS), platform as a service (PaaS), and serverless.<br><img src="https://i0.wp.com/tvax1.sinaimg.cn/large/a60edd42gy1giulu4by1nj219h0fnabt.jpg" alt="IaaS"><br>IaaS 通常用于以下场景：迁移工作负载；测试和开发；存储、备份和恢复。<br>Caution！ 虚拟机是IaaS</p>
<p>例题：Your company plans to migrate all its data and resources to Azure.<br>The company’s migration plan states that only platform as a service (PaaS) solutions must be used in Azure.<br>You need to deploy an Azure environment that supports the planned migration.<br>Solution: You create an Azure App Service and Azure SQL databases.</p>
<p>A: Correct. Azure SQL databases 也属于 PaaS，区别于在虚拟机中安装的SQL Server（IaaS）</p>
<p>例题：Your company plans to migrate all its data and resources to Azure.<br>The company’s migration plan states that only Platform as a Service (PaaS) solutions must be used in Azure.<br>You need to deploy an Azure environment that meets the company migration plan.<br>Solution: You create an Azure App Service and Azure Storage accounts. </p>
<p>A: False. Azure Storage accounts is IaaS</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/cosmos-db/introduction">Cosmos DB</a> is PaaS</p>
<h4 id="区域、中心"><a href="#区域、中心" class="headerlink" title="区域、中心"></a>区域、中心</h4><p>Q:Deploying an app can be done directly to what level of physical granularity(尺度)? A:Region</p>
<p>You need to ensure that the services running on the virtual machines are available if a  single data center fails.<br>Solution: You deploy the virtual machines to two or more regions.<br>or You deploy the virtual machines to two or more availability zones</p>
<p>区域间数据传输根据带宽收费</p>
<blockquote>
<p>Azure availability zone can be used to protect access to Azure services from an Azure data center failure</p>
</blockquote>
<h4 id="计价"><a href="#计价" class="headerlink" title="计价"></a>计价</h4><p>例题：If you create two Azure virtual machines that use the B2S size, each virtual machine will always generate the same monthly costs.（False）</p>
<p>Two virtual machines using the same size could have different disk configurations. Therefore, the monthly<br>costs could be different.</p>
<p>“pay-as-you-go”<br><br>When planning to migrate a public website to Azure, you must plan to pay monthly usage costs. .</p>
<p>“elasticity”<br><br><a target="_blank" rel="noopener" href="https://azure.microsoft.com/zh-cn/overview/what-is-elastic-computing/">弹性计算</a>, 系统监控工具控制，无需中断操作即可使分配的资源量与实际所需资源量相匹配。通过云灵活性，公司可避免就未用容量或闲置资源付费，且不必担心投入资金购买或维护额外的资源和设备。</p>
<h4 id="订阅"><a href="#订阅" class="headerlink" title="订阅"></a>订阅</h4><blockquote>
<p>An Azure AD tenant can have multiple subscriptions but an Azure subscription can only be associated with one Azure AD tenant.<br>见<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/active-directory/fundamentals/active-directory-how-subscriptions-associated-directory">将 Azure 订阅关联或添加到 Azure Active Directory 租户</a></p>
</blockquote>
<p><img src="https://docs.microsoft.com/zh-cn/azure/azure-resource-manager/management/media/overview/scope-levels.png" alt=""></p>
<h4 id="资源组"><a href="#资源组" class="headerlink" title="资源组"></a>资源组</h4><blockquote>
<p>A resource can interact with resources in other resource groups</p>
<p>Deleting the resource group will remove the resource group as well as all the resources in that resource group. </p>
<p>Resources from multiple different regions can be placed in a resource group.</p>
<ul>
<li>资源组中的所有资源应该具有相同的生命周期。 一起部署、更新和删除这些资源。 </li>
<li>每个资源只能存在于一个资源组中。可以将资源从一个资源组移到另一个组</li>
<li>资源组中的资源可以位于与资源组不同的区域。 </li>
</ul>
</blockquote>
<p>锁定资源以防止意外：<br>CanNotDelete和ReadOnly, 资源可以存在多个删除锁，自动继承上层锁。</p>
<p><b>Azure virtual machines</b> should you use from the Azure portal to view service failure notifications that can<br>affect the availability of VM1(your virtual machine)?</p>
<p>例题：You need to view a list of planned maintenance events that can affect the availability of an Azure subscription.</p>
<p>On the <b>Help and Support</b> blade, there is a Service Health option. If you click Service Health, a new blade opens. The Service Health blade contains the Planned Maintenance link which opens a blade where you can view a list of planned maintenance events that can affect the availability of an Azure subscription.</p>
<h4 id="Azure服务"><a href="#Azure服务" class="headerlink" title="Azure服务"></a>Azure服务</h4><p>An integrated solution for the deployment of code - <b>Azure DevOps</b><br>A tool that provides guidance and recommendation to improve an Azure environment - <b>zure Advisor</b><br>A simplified tool to build intelligent Artificial Intelligence (AI) applications - <b>Azure Cognitive services</b><br>Monitors web applications - <b>Azure Application Insights</b></p>
<h4 id="规模集（scale-set）"><a href="#规模集（scale-set）" class="headerlink" title="规模集（scale set）"></a>规模集（scale set）</h4><p>如用于创建并管理一组负载均衡的 VM，根据需求或定义的计划自动增减 VM 实例的数目，为应用程序提供搞可用性</p>
<h4 id="DevTest-Lab"><a href="#DevTest-Lab" class="headerlink" title="DevTest Lab"></a>DevTest Lab</h4><p>开发测试实验室，利用基架/模板快速创建环境</p>
<h4 id="存储账户"><a href="#存储账户" class="headerlink" title="存储账户"></a>存储账户</h4><blockquote>
<p>Data that is copied to Azure Storage account is maintained automatically in at least three copies.</p>
</blockquote>
<p>存储账户的数据冗余选项有4个 每种都以不同的措施复制三次 见<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/storage/common/storage-account-overview">存储帐户概述</a></p>
<h4 id="Cloud-shell"><a href="#Cloud-shell" class="headerlink" title="Cloud shell"></a>Cloud shell</h4><p>Cloud shell就是页面上那个命令行工具，从中可以运行PowerShell命令或Bash命令</p>
<p>另install azure cli then it can be used in Command Prompt or Windows PowerShell </p>
<p>例题：An Azure administrator plans to run a PowerShell script that creates Azure resources. You need to recommend which computer configuration to use to run the script.<br>Solution: Run the script from a computer that runs Linux and has the Azure CLI tools installed.<br>Does this meet the goal?</p>
<p>answer：A PowerShell script is a file that contains PowerShell cmdlets and code. A PowerShell script needs to be run in PowerShell.<br>PowerShell can now be installed on Linux. However, the question states that the computer has Azure CLI tools, not PowerShell installed. Therefore, this solution does not meet the goal.</p>
<p>PowerShell已经是跨平台应用,可以装在linux，azure cli是command line interface可以认为是命令集合，依托于windows cmd或powershell。上面的题目想说powershell脚本运行基于powershell应用而不是azure cli package，私以为题目很无聊。<br>官方教程的练习：<br>What do you need to install on your machine to let you execute Azure CLI commands locally?<br><b>A</b>.<i>The Azure cloud shell</i>  <b>B</b>.<i>The Azure CLI and Azure PowerShell</i>  <b>C</b>.<i>Only the Azure CLI</i></p>
<ol>
<li>True or false: The Azure CLI can be installed on Linux, macOS, and Windows, and the CLI commands you use are the same in all platforms.<br><b>A</b>.<i>True</i>  <b>B</b>.<i>False</i></li>
<li>Which parameter can you add to most CLI commands to get concise, formatted output?<br><b>A</b>.<i>list</i>  <b>B</b>.<i>table</i>  <b>C</b>.<i>group</i></li>
</ol>
<p>answer is C A B</p>
<p>Azure命令行没有ping，而使用tcpping</p>
<h4 id="Data-Lake"><a href="#Data-Lake" class="headerlink" title="Data Lake"></a>Data Lake</h4><p>例题：You plan to store 20 TB of data in Azure. The data will be accessed infrequently and visualized by using Microsoft Power BI.<br>You need to recommend a storage solution for the data.<br>A. Azure Data Lake<br>B. Azure Cosmos DB<br>C. Azure SQL Data Warehouse<br>D. Azure SQL Database<br>E. Azure Database for PostgreSQL </p>
<p>answer is AC，<a target="_blank" rel="noopener" href="https://azure.microsoft.com/zh-cn/solutions/data-lake/">Azure Data Lake</a></p>
<h4 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h4><p> <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal">Local Network Gateway 创建从azure到本地网关的连接</a> </p>
<p>You have an Azure environment that contains 10 virtual networks and 100 virtual machines.<br>You need to limit the amount of inbound traffic to all the Azure virtual networks.<br>What should you create?<br>A. one application security group (ASG)<br>B. 10 virtual network gateways<br>C. 10 Azure ExpressRoute circuits<br>D. one Azure firewall </p>
<p>answer is D</p>
<h4 id="Advanced"><a href="#Advanced" class="headerlink" title="Advanced"></a>Advanced</h4><p>2020.9.26勉强通过 准备AZ-303 + AZ-304 即成为Azure Solutions Architect Expert</p>
<blockquote>
<p>It certainly wouldn’t hurt you to have your <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/learn/certifications/exams/az-104">Microsoft Azure Administrator</a> in the bag before attempting to take down this colossal certification and its dual architecture-focused exams. ————<a target="_blank" rel="noopener" href="https://acloudguru.com/blog/engineering/which-azure-certification-is-right-for-me">《Which Azure certification is right for me?》</a></p>
</blockquote>
<p>即建议通过AZ-104获得Azure Administrator Associate认证，难度只有两星，费用是115刀</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/108076190">知乎：Azure 框架设计师认证考试2020大更改</a></p>
<blockquote>
<p>原AZ-103将被新的AZ-104替代，原AZ-300将被新的AZ-303替代，原AZ-301将被新的AZ-304替代<br>AZ-103的考试侧重点分配如下</p>
</blockquote>
<p>管理 Azure 订阅和资源 (15-20%)<br>实施和管理存储 (15-20%)<br>部署和管理虚拟机 (VM) (15-20%)<br>配置和管理虚拟网络 (30-35%)<br>管理身份 (15-20%)</p>
<p>在新的AZ-104中，这些权重将会有一些修改。</p>
<p>订阅Subscription和身份认证Identity将会合并成单独的身份认证Identity<br>新增考点监控和备份（Monitor and Backup）<br>新增主题： 网络程序和容器（Web apps and containers）</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/learn/certifications/exams/az-104">Two ways to prepare</a> 见页面下方官方文档</p>
<p>AZ-300的考试权重分配如下</p>
<ul>
<li>部署和配置基础设施 (25-30%)</li>
<li>实现工作负载和安全 (20-25%)</li>
<li>创建和部署 App (5-10%)</li>
<li>实现认证和安全数据（5-10%）</li>
<li>开发云和 Azure 存储 (20-25%)</li>
</ul>
<p>在新的<a target="_blank" rel="noopener" href="https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RE4psD6">AZ-303</a>中，这些权重将会有一些修改。</p>
<ul>
<li>考试中有50%的部分是关于部署和配置（Deploy and Configure）</li>
<li>去掉了对认证和安全数据的要求</li>
<li>去掉了对云开发：消息和自动扩展的要求</li>
<li>新增部署数据平台的要求，包括SQL DB和Cosmos DB</li>
<li>新增监控的要求 Monitoring</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/learn/certifications/exams/az-303">Two ways to prepare</a> 见页面下方官方文档</p>
<p>AZ-301的考试权重分配如下</p>
<ul>
<li>确定工作量要求 (10-15%)</li>
<li>设计身份和安全性 (20-25%)</li>
<li>设计数据平台解决方案 (15-20%)</li>
<li>设计业务连续性策略(15-20%)</li>
<li>部署、迁移和集成设计（10-15%）</li>
<li>设计基础设施策略（15-20%）</li>
</ul>
<p>在新的<a target="_blank" rel="noopener" href="https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RE4pCWz">AZ-304</a>中，这些权重将会有一些修改。</p>
<ul>
<li>去掉获取信息和要求的部分</li>
<li>去掉设计认证管理的部分</li>
<li>去掉危险预防策略的部分</li>
<li>去掉数据文档流的部分</li>
<li>去掉数据保护策略的部分</li>
<li>去掉数据监控策略的部分</li>
<li>去掉存储策略的部分</li>
<li>添加设计程序框架</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/learn/certifications/exams/az-304">Two ways to prepare</a> 见页面下方官方文档</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qqstone.github.io/qqsnote/2020/07/16/React-Ecosystem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/qqsnote/images/avatar.gif">
      <meta itemprop="name" content="QQs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QQs'Note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/qqsnote/2020/07/16/React-Ecosystem/" class="post-title-link" itemprop="url">React-Ecosystem</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-16 17:31:15" itemprop="dateCreated datePublished" datetime="2020-07-16T17:31:15+08:00">2020-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-19 17:31:00" itemprop="dateModified" datetime="2025-10-19T17:31:00+08:00">2025-10-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="MaterialUI"><a href="#MaterialUI" class="headerlink" title="MaterialUI"></a>MaterialUI</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add @material-ui&#x2F;core</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://blog.bitsrc.io/4-ways-to-override-material-ui-styles-43aee2348ded">override material ui styles</a></p>
<h4 id="Next-js"><a href="#Next-js" class="headerlink" title="Next.js"></a><a target="_blank" rel="noopener" href="https://github.com/vercel/next.js">Next.js</a></h4><p>典型的网站模块和框架，封装webpack、babel, 支持按需加载和seo优化</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/54832736/send-variable-to-withstyles-in-material-ui">styled component</a></p>
<p>SSR和水合作用</p>
<p>在服务器端已经渲染好的 HTML “骨架”上，附加上 JavaScript 的事件和交互逻辑，使其从一个静态页面变成一个完全可交互的 React 应用的过程。</p>
<h4 id="Redux"><a href="#Redux" class="headerlink" title="Redux"></a>Redux</h4><p>React提供了视图层面组件化开发的模式。为实现组件之间通信和多样的交互，需要引入Redux库</p>
<blockquote>
<p>Redux is a predictable state container for JavaScript apps.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npx create-react-app my-app --template redux-typescript</span><br><span class="line">npm install @reduxjs&#x2F;toolkit</span><br></pre></td></tr></table></figure></p>
<h4 id="store，-state，-action"><a href="#store，-state，-action" class="headerlink" title="store， state， action"></a>store， state， action</h4><p>一个应用中只有一个store，是所有组件数据的容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import &#123; createStore &#125; from &#39;redux&#39;;</span><br><span class="line">const store &#x3D; createStore(fn);</span><br><span class="line"></span><br><span class="line">const state &#x3D; store.getState();</span><br></pre></td></tr></table></figure><br>state是state在某个时间点的快照，state与view绑定</p>
<h4 id="preact"><a href="#preact" class="headerlink" title="preact"></a>preact</h4><p>据说是使用更符合Dom规范的事件系统，直接使用浏览器原生事件系统而不是统一用onChange，从而对React的设计进行了简化<sup><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/65479147/answer/942582216">注1</a></sup></p>
</blockquote>
<h4 id="craco"><a href="#craco" class="headerlink" title="craco"></a>craco</h4><p>create-react-application-configure-override<br><a target="_blank" rel="noopener" href="https://github.com/gsoft-inc/craco">craco</a>,当下流行的对React项目进行自定义配置的社区解决方案，<a target="_blank" rel="noopener" href="https://ant.design/docs/react/use-with-create-react-app-cn#%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE">AntDesign4</a>官方亦有在使用<br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1749704">更骚的create-react-app开发环境配置craco</a><br>从create-react-app开始配置(关于create-react-app见<a href="/qqsnote/2020/06/29/React/" title="React">React</a>)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npx create-react-app my-project </span><br><span class="line">npx create-react-app my-project --template typescript</span><br><span class="line">yarn add antd @craco&#x2F;craco craco-less @babel&#x2F;plugin-proposal-decorators babel-plugin-import -D</span><br></pre></td></tr></table></figure><br>添加craco配置 craco.conf.js，即模块化配置，根据所需的资源参考方案：<a target="_blank" rel="noopener" href="https://github.com/gsoft-inc/craco/tree/master/recipes">https://github.com/gsoft-inc/craco/tree/master/recipes</a></p>
<p>package.json scripts将命令替换为craco<br><del>&nbsp;&nbsp;”start”: “react-scripts start”,<br>&nbsp;&nbsp;”build”: “react-scripts build”,<br>&nbsp;&nbsp;”test”: “react-scripts test”,<br>&nbsp;&nbsp;”eject”: “react-scripts eject”</del><br>&nbsp;&nbsp;”start”: “craco start”,<br>&nbsp;&nbsp;”build”: “craco build”,<br>&nbsp;&nbsp;”test”: “craco test”</p>
<h4 id="format-js-国际化"><a href="#format-js-国际化" class="headerlink" title="format.js 国际化"></a>format.js 国际化</h4><p>见<a href="/qqsnote/2021/04/14/formatjs/" title="format.js">format.js</a></p>
<h4 id="react-router"><a href="#react-router" class="headerlink" title="react router"></a>react router</h4><p>安装react-router-dom,这个package是基于react-router开发的，且实现了现成的组件如Link Switch等<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ReactDOM.render(</span><br><span class="line">    &lt;BrowserRouter&gt;</span><br><span class="line">        &lt;AppRoutes &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;BrowserRouter&gt;,</span><br><span class="line">)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">const AppRoutes &#x3D; () &#x3D;&gt; &#123;</span><br><span class="line">    return (</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">            &lt;nav&gt;</span><br><span class="line">                &lt;ul&gt;</span><br><span class="line">                    &lt;li&gt;&lt;Link to&#x3D;&quot;&#x2F;dashboard&quot;&gt;Dashboard&lt;&#x2F;Link&gt;&lt;&#x2F;li&gt;</span><br><span class="line">                    &lt;li&gt;&lt;Link to&#x3D;&quot;&#x2F;device&quot;&gt;Device&lt;&#x2F;Link&gt;&lt;&#x2F;li&gt;</span><br><span class="line">                    &lt;li&gt;&lt;Link to&#x3D;&quot;&#x2F;squre&quot;&gt;Squre&lt;&#x2F;Link&gt;&lt;&#x2F;li&gt;</span><br><span class="line">                &lt;&#x2F;ul&gt;</span><br><span class="line">            &lt;&#x2F;nav&gt;</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;Route path&#x3D;&quot;&#x2F;dashboard&quot; component&#x3D;&#123;Dashboard&#125; &#x2F;&gt;</span><br><span class="line">                &lt;Route path&#x3D;&quot;&#x2F;device&quot; component&#x3D;&#123;Device&#125; &#x2F;&gt;</span><br><span class="line">                &lt;Route path&#x3D;&quot;&#x2F;squre&quot; component&#x3D;&#123;Squre&#125; &#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="拖拽-react-dnd"><a href="#拖拽-react-dnd" class="headerlink" title="拖拽 react-dnd"></a>拖拽 react-dnd</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function DraggableComponent(props) &#123;</span><br><span class="line">  const [collected, drag, dragPreview] &#x3D; useDrag(() &#x3D;&gt; (&#123;</span><br><span class="line">    type,</span><br><span class="line">    item: &#123; id &#125;</span><br><span class="line">  &#125;))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>useDrag钩子, 接受一个specification配置 声明拖动的type 被拖动项item 需要回传的collect， 返回collect的属性，drag source的引用以及drag preview元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const [&#123; isOver, canDrop &#125;, dropRef] &#x3D; useDrop(&#123;</span><br><span class="line">    accept,</span><br><span class="line">    drop: onDrop,</span><br><span class="line">    collect: (monitor) &#x3D;&gt; (&#123;</span><br><span class="line">        isOver: monitor.isOver(),</span><br><span class="line">        canDrop: monitor.canDrop(),</span><br><span class="line">    &#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><br>useDrop钩子接收一个‘specification’配置作为参数 可配置drop-target接收的类型 需要回传的props参数<br>返回包含drop-target节点的reference以及回传的props如{isOver, canDrop}的一个列表 </p>
<p>trouble shooting <a target="_blank" rel="noopener" href="https://juejin.cn/post/7096393191691124750">Can’t resolve ‘react/jsx-runtime’</a></p>
<h4 id="vite-js"><a href="#vite-js" class="headerlink" title="vite.js"></a>vite.js</h4><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7387669136272080936?searchId=202411051613195B2A3CE6D9FACF9F2396">Vite vs Webpack</a></p>
<h4 id="emotion-react"><a href="#emotion-react" class="headerlink" title="@emotion/react"></a>@emotion/react</h4><p>css in js方案</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qqstone.github.io/qqsnote/2020/07/16/Reading-Meditations%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/qqsnote/images/avatar.gif">
      <meta itemprop="name" content="QQs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QQs'Note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/qqsnote/2020/07/16/Reading-Meditations%20/" class="post-title-link" itemprop="url">《沉思录》</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-16 17:31:15" itemprop="dateCreated datePublished" datetime="2020-07-16T17:31:15+08:00">2020-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-05 10:07:52" itemprop="dateModified" datetime="2025-07-05T10:07:52+08:00">2025-07-05</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="在继承中闪耀的美德"><a href="#在继承中闪耀的美德" class="headerlink" title="在继承中闪耀的美德"></a>在继承中闪耀的美德</h4><blockquote>
<p>灵魂之所以会伤害自身 往往都是它无法承受快乐或痛苦的时候</p>
</blockquote>
<p>不以物喜，不以己悲，居庙堂之高，则忧其民；处江湖之远，则忧其君。是进亦忧，退亦忧；然则何时而乐耶？其必曰：“先天下之忧而忧，后天下之乐而乐”呼！噫！微斯人，吾谁与归？</p>
<h4 id="理性的灵魂基于理性的生物"><a href="#理性的灵魂基于理性的生物" class="headerlink" title="理性的灵魂基于理性的生物"></a>理性的灵魂基于理性的生物</h4><h4 id="天地规律是我们必须遵守的"><a href="#天地规律是我们必须遵守的" class="headerlink" title="天地规律是我们必须遵守的"></a>天地规律是我们必须遵守的</h4><h4 id="生前伟大-死后遗忘"><a href="#生前伟大-死后遗忘" class="headerlink" title="生前伟大 死后遗忘"></a>生前伟大 死后遗忘</h4><h4 id="与傻瓜对话我们即为傻瓜"><a href="#与傻瓜对话我们即为傻瓜" class="headerlink" title="与傻瓜对话我们即为傻瓜"></a>与傻瓜对话我们即为傻瓜</h4><blockquote>
<p>做事不可迟缓，言谈不可杂乱，思想不可漂游，灵魂不可全然倾注自我，也不可总被外物烦扰，生活不可始终忙碌不止</p>
</blockquote>
<h4 id="为了人类的进步我应多做有意义的事"><a href="#为了人类的进步我应多做有意义的事" class="headerlink" title="为了人类的进步我应多做有意义的事"></a>为了人类的进步我应多做有意义的事</h4><blockquote>
<p>人与人之间，即相互鄙视，又相互奉承，每个人都希望自己高人一等，又匍匐在别人面前</p>
</blockquote>
<p>马可·奥勒留在位的第5年是45岁，按现在的平均寿命而言他正值春秋鼎盛，这一年就是公元166年，他在这一年达成了养父安敦尼的政治遗愿——联通了中国。中国和罗马的史书都没有记载这次联通的结果，当时在位的皇帝是汉桓帝</p>
<p>奥勒留所在的历史时期命名为“安敦尼王朝”，这个时期的罗马帝国有6位皇帝，按次序分别是涅尔瓦、图拉真、哈德良、安敦尼、马可·奥勒留和康茂德。之所以如此称谓是因为其时的罗马统治者一般都认为，安敦尼的统治时期是罗马帝国最发达最繁荣的时代，并认为元首本人就是最理想君主的摹本，并把王朝中康茂德之前的五任皇帝评价为“五贤帝”，奥勒留是五贤帝的最后一位。</p>
<p>屋大维统治晚期，政治遗嘱建议罗马的疆域不再扩张，此后直到罗马分裂，其疆域一直保有着横跨欧亚非三个大陆的庞大体量。极度不发达的交通、极度辽阔的幅员和繁星满天的种族信仰所伴生的运转不灵兼供血不足，直接导致了巨人症帝国的统治矛盾丛生蔓长且无处不在。以奥勒留为例，如果形容他的统治期，最接地气的莫过于中国诗人王勃的16字咒“时运不济、命运多舛、冯唐易老、李广难封”。</p>
<p>奥勒留于162年继位成为罗马帝国皇帝。在前一年，帕提亚的沃洛吉斯四世（Vologases IV）继位，开始入侵亚美尼亚和叙利亚，重夺埃德萨，奥勒留的养父安敦尼在忧愤中去世，奥勒留“奉命于危难之间”，接过了充满了硝烟的权杖，而这场战争一直打到奥勒留特使抵达中国洛阳的那一年——罗马有心东来，中国却无暇西顾。</p>
<p>奥勒留的罗马处境远不止于此，在北方边境，马科曼尼人、夸狄人、萨马坦人、恺悌人和扎则基斯人等日耳曼部族都相继发动叛乱。巧合的还是公元166年——叛乱的先头部队一度冲进北部意大利。奥勒留当局被迫开启了全民皆兵模式，把奴隶和角斗士都编入军队。终奥勒留一生，这身扑火队长的行头一直没能脱下。180年3月17日，他死在了征讨马科曼尼人的多瑙河边的Pannonia省（现威尼斯），只是他并非战死而是死于瘟疫，而这场瘟疫也是奥勒留继位初期的种因。</p>
<p>奥勒留继位做的第一举措，就是邀请安敦尼的另一养子维鲁斯共理国事，这是罗马帝国史上首度出现两帝共治。随后罗马安息战争的东方战事，奥勒留就托付给维鲁斯处理，维鲁斯率兵攻陷并焚毁了塞琉西亚和泰西封，与此同时一些士兵染上莫名且致命的传染病，军队因此撤回国内。这些近东作战的士兵带来了天花和麻疹，大瘟疫序幕拉开。死亡之霾悄无声息地从小亚细亚半岛暴风一般席卷了帝国东部，旋即迅速蔓延到西部的意大利、高卢和日耳曼地区，罗马帝国所有的行省都无一幸免。两个共治皇帝均病殁于这次瘟疫。更具讽刺意味的是，这次史上称为“安东尼瘟疫”的传染病，正是以奥勒留（马可·奥勒留·安东尼·奥古斯都）的名字命名的。</p>
<p>这是传染病学史上的一次大事件，也是人类历史上十大恶性传染病事件之一。它继古希腊“雅典大瘟疫”之后，拜占庭“查士丁尼瘟疫”之前，为一千多年以后蔓延欧洲的黑死病风暴（即欧洲中世纪大瘟疫）开了先河。这场瘟疫，使包括社会精英在内的众多人口集体毙命。如雅典，在167-171年间，首席法官的职务就因候选人病死而无法补足。考虑到相似体制的行政单位还有许多，不少地方的基层治理能力就因此遭遇重创。罗马史学家迪奥卡称，当时罗马一天就有2千人因染病而死，占总传染人数的1/4；而在有些地方，瘟疫造成总人口的1/3死亡。估计总死亡人数有500万。</p>
<p>奥勒留当局不得不从普通奴隶或角斗士队伍中招募新兵。但老兵的安抚与新人的入职，无不需要大笔资金维持，而帝国的银矿开采也因瘟疫而陷入停顿，如东方商业重镇亚历山大港的银币铸造完全停止，商品价格普遍上涨而地租却巨幅下跌。梁实秋曾如此描述“民穷财困，局势日非，玛克斯（即马可·奥勒留）被迫出售私人所藏珠宝，筹款赈灾。此种困窘情形，在玛克斯在位之日，一直继续存在。内忧外患，交相煎迫。”这场瘟疫就像巨人泰坦的铁拳，将帝国的各级秩序敲得摇摇欲坠，几乎所有的行业均震荡备至。</p>
<p>这场瘟疫足足肆虐了7年之后才趋于消停。当在公元191年再度大规模爆发的时候，奥勒留已经去世11年了。</p>
<p>兵戈瘟疫之外也并非全部，还有洪水泛滥，此处不赘。穷其执政期间，奥勒留如同暴风雨中海上的一叶小舢舨，无时无刻不处在鞍马倥偬和颠踣动荡中。人类万物的恒性在于追求平衡，外面越是风雨雷电，内里越是风淡云清，否则必然走向崩溃和灭失。你既然理解太平天国运动中的曾国藩、宁王之乱中的王阳明，那你也必然会理解奥勒留为什么成了“哲学家皇帝”了。</p>
<p>今人不见古时月，今月曾经照古人。<br>古人今人若流水，共看明月皆如此。<br>唯愿当歌对酒时，月光长照金樽里。</p>
<p>行文不像书籍 主旨零散 更像是日记的随笔 深夜寂寞的灯下与自己内心的对话<br>我未伏案研读 肯定觉得枯燥 跑步时听的 在这种有氧运动中放空自己时 听到这样的文字 容易引起共鸣<br>你想这个跟你对话的是一千八百年前的‘古人’呀 而且还是皇帝 一位皇帝 高居庙堂 掌握着古罗马的超大版图 这种人物应该鲜有闲情逸致写这种散漫的文字<br>我们从经典古文中鲜有这种近距离之感</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qqstone.github.io/qqsnote/2020/07/10/pm2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/qqsnote/images/avatar.gif">
      <meta itemprop="name" content="QQs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QQs'Note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/qqsnote/2020/07/10/pm2/" class="post-title-link" itemprop="url">pm2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-10 10:25:14" itemprop="dateCreated datePublished" datetime="2020-07-10T10:25:14+08:00">2020-07-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-05 10:07:52" itemprop="dateModified" datetime="2025-07-05T10:07:52+08:00">2025-07-05</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="directives"><a href="#directives" class="headerlink" title="directives"></a>directives</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pm2 start index.js</span><br><span class="line">pm2 stop all</span><br><span class="line">pm2 logs</span><br><span class="line">pm2 delete all</span><br></pre></td></tr></table></figure>
<h4 id="env-variables"><a href="#env-variables" class="headerlink" title="env variables"></a>env variables</h4><p>将node.js应用封装成模块ecosystem.config.js （也可以直接用json）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  apps : [</span><br><span class="line">      &#123;</span><br><span class="line">        name: &quot;myapp&quot;,</span><br><span class="line">        script: &quot;.&#x2F;app.js&quot;,</span><br><span class="line">        watch: true,</span><br><span class="line">        env: &#123;</span><br><span class="line">            &quot;PORT&quot;: 3000,</span><br><span class="line">            &quot;NODE_ENV&quot;: &quot;development&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        env_production: &#123;</span><br><span class="line">            &quot;PORT&quot;: 80,</span><br><span class="line">            &quot;NODE_ENV&quot;: &quot;production&quot;,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>在启动命令时使用env_后面的字符串作为标识<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 start ecosystem.config.js --env production</span><br></pre></td></tr></table></figure></p>
<h4 id="pm2-plus"><a href="#pm2-plus" class="headerlink" title="pm2 plus"></a>pm2 plus</h4><p>know more about <a target="_blank" rel="noopener" href="https://app.pm2.io/">pm2.io</a></p>
<h4 id="开机自启"><a href="#开机自启" class="headerlink" title="开机自启"></a>开机自启</h4><p>键入下面的命令生成startup脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 startup</span><br></pre></td></tr></table></figure><br>提示执行配置命令,如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[PM2] To setup the Startup Script, copy&#x2F;paste &gt;the following command:&quot;, </span><br><span class="line">sudo env &gt;PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;bin &#x2F;usr&#x2F;local&#x2F;lib&#x2F;node_modules&#x2F;pm2&#x2F;bin&#x2F;pm2 startup systemd -u username --hp &#x2F;home&#x2F;username</span><br></pre></td></tr></table></figure><br>按照提示执行提示的命令, 执行后终端列出已安装的服务信息</p>
<p>Caution！升级nodejs对startup有影响<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pm2 unstartup</span><br><span class="line"></span><br><span class="line">pm2 startup</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qqstone.github.io/qqsnote/2020/07/01/Azure-AD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/qqsnote/images/avatar.gif">
      <meta itemprop="name" content="QQs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QQs'Note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/qqsnote/2020/07/01/Azure-AD/" class="post-title-link" itemprop="url">Azure-ADB2C</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-01 10:09:03" itemprop="dateCreated datePublished" datetime="2020-07-01T10:09:03+08:00">2020-07-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-12-04 15:19:52" itemprop="dateModified" datetime="2025-12-04T15:19:52+08:00">2025-12-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/qqsnote/categories/%E4%BA%91%E5%B9%B3%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">云平台</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="Azure-AD"><a href="#Azure-AD" class="headerlink" title="Azure AD"></a>Azure AD</h4><p>Windows2000 引入Active Directory作为identity provider和authorization database，<del>可想而知，这个名称与其存储方式以及根据talent区分的文件结构之间的关系。</del>随着Web应用的发展，有了云平台的Azure Active Directory，其主要功能之一仍是作为identity provider。</p>
<p>AD和Azure AD的结合实现了以本地Windows身份通过web实现SSO认证。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://jumpcloud.com/blog/is-azure-ad-an-identity-provider#cookie-accept">《Is Azure AD an Identity Provider?》</a></p>
<p>Azure AD在office软件甚至其他Saas（Software as a service, 软件即服务）之间无缝访问，以及多重身份验证和条件访问控制</p>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/active-directory/manage-apps/what-is-application-management">使用 Azure Active Directory 进行应用程序管理</a></p>
<p><a target="_blank" rel="noopener" href="https://www.predicagroup.com/blog/azure-ad-b2b-b2c-puzzled-out/">Azure AD, B2B, B2C Puzzled Out – What Makes The Difference?</a></p>
<p>B2B，对接Business和Business，使双方标识均可通过认证，主服务方持有访问权限的控制，<br><br>B2C, 面向customer 如下引述：</p>
<blockquote>
<p>Azure Active Directory B2C provides business-to-customer identity as a service. Your customers use their preferred social, enterprise, or local account identities to get single sign-on access to your applications and APIs.</p>
</blockquote>
<p>Azure Active Directory B2C 以服务的形式提供企业到客户的身份。 客户可使用其喜欢的社交、企业或本地帐户标识完成单点登录，访问应用程序和 API 。<br><img src="https://docs.azure.cn/zh-cn/active-directory-b2c/media/overview/azureadb2c-overview.png" alt="azureadb2c-overview"></p>
<p>“贴牌式身份验证解决方案” blabla<br></p>
<p>届时，访问DataService，跳转到如 CSDataServices.onmicrosoft.com/oauth2/v2.0/authorize?xxxx 格式的地址, 这是挂在Azure上的页面，可以做成本公司产品风格(见本文章节自定义登录页)，sign in的form可以直接使用已注册（保存在Azure AD）的账号, 也可能提供了社交账号的链接，点击后跳转到社交平台登录页。<br><img src="https://docs.microsoft.com/zh-cn/azure/active-directory-b2c/media/overview/sign-in-small.png" alt="sign_in"></p>
<p>Azure保存用户的标识，即使使用第三方的sso如公司的sso认证或社交账号，也会有将第三方凭据交换Azure标识的过程，该过程即典型的OAuth2</p>
<p><img src="https://docs.microsoft.com/zh-cn/azure/active-directory-b2c/media/overview/scenario-singlesignon.png" alt="scenario-singlesignon"></p>
<p>名称和概念</p>
<ul>
<li>authority 颁发机构 形如 <a target="_blank" rel="noopener" href="https://login.microsoftonline.com/tfp/{tenant}/{policyName}">https://login.microsoftonline.com/tfp/{tenant}/{policyName}</a></li>
<li>tenantID 注册使用AAD 成为“tenant” 获得tenantID 由tenant name命名的子域名等</li>
<li>directory 存储所涉及的对象（如凭据，用户信息，配置）的物理或逻辑位置 </li>
<li>Application registration 将自己公司产品注册为Azure AD B2C的App,以使用由Azure提供的贴牌认证</li>
<li>user flow 和 costom policy分别指基本的注册-登录-配置的流程以及自定义的策略</li>
<li>identity providers 第三方的标识提供方 如Facebook账号或Wechat账号授权服务 </li>
</ul>
<h4 id="Azure-ADB2C"><a href="#Azure-ADB2C" class="headerlink" title="Azure ADB2C"></a>Azure ADB2C</h4><p>Active Directory 的identity是在login.microsoftonline.com注册的，登录Azure portal也是同样的唯一的账号，B2C则提供了选择多个identity provider的功能，可以使用自己注册的tenant，抑或是社交账号，注册登录入口形如<a target="_blank" rel="noopener" href="https://qqstudio.b2clogin.com/qqstudio.onmicrosoft.com/oauth2/v2.0/authorize">https://qqstudio.b2clogin.com/qqstudio.onmicrosoft.com/oauth2/v2.0/authorize</a><br>下面以官方sample为例配置，以求使用<a target="_blank" rel="noopener" href="https://github.com/Azure-Samples/active-directory-b2c-dotnet-desktop.git">wpf桌面客户端</a>通过Azure AD B2C的认证框架访问<a target="_blank" rel="noopener" href="https://github.com/Azure-Samples/active-directory-b2c-javascript-nodejs-webapi.git">Web Api</a></p>
<h4 id="域服务-AD-DS-和应用程序管理"><a href="#域服务-AD-DS-和应用程序管理" class="headerlink" title="域服务(AD DS)和应用程序管理"></a>域服务(AD DS)和应用程序管理</h4><p>即除了B2C之外的主要功能。AD DS见<a href="/qqsnote/2020/11/24/Azure-ADDS/" title="Azure域服务">Azure域服务</a><br>AD可以用于管理Gallery App也就是微软库中的SaaS应用，也可以通过应用程序代理管理本地的应用(On-premises applications)<br>What does Azure AD Application Proxy do?<br>A.You use it to identify applications in your instance of Azure AD.<br>B.You use it to add on-premises applications to your instance of Azure AD.<br>C.You use it to add Azure AD Gallery applications to your instance of Azure AD.</p>
<h4 id="创建资源"><a href="#创建资源" class="headerlink" title="创建资源"></a>创建资源</h4><p>进入“创建资源”入口，搜索Azure AD B2C，选择创建—&gt;给出两个选项,选择创建新的<br><img src="https://docs.microsoft.com/zh-cn/azure/active-directory-b2c/media/tutorial-create-tenant/portal-02-create-tenant.png" alt="micro docs"><br>loading半天后提示创建成功，点击链接切换directory</p>
<p>Directory creation was successful. Click here to navigate to your new directory: QQStudio.</p>
<p><img src="https://i0.wp.com/tvax3.sinaimg.cn/large/a60edd42gy1ggqjwy66qzj20ry0kc0vz.jpg" alt="directory created"></p>
<h4 id="user-flow"><a href="#user-flow" class="headerlink" title="user flow"></a>user flow</h4><p>选择由Azure AD B2C控制的行为，一般就是登入登出，注册、注销，重置密码。<br><br>选择Sign up and sign in<br><img src="https://docs.microsoft.com/zh-cn/azure/active-directory-b2c/media/tutorial-create-user-flows/signup-signin-type.png" alt=""><br>输入user flow名称<br><br>选择email作为sign up的身份验证<br><br>选择需要收集的注册信息<br><img src="https://docs.microsoft.com/zh-cn/azure/active-directory-b2c/media/tutorial-create-user-flows/signup-signin-attributes.png" alt=""></p>
<p>关于reset password</p>
<blockquote>
<p>使用本地帐户的 注册或登录 用户流在体验的第一个页面上包含“忘记了密码?”链接。 单击此链接不会自动触发密码重置用户流。<br>而是将错误代码 AADB2C90118 返回给应用程序。 应用程序需要通过运行一个可重置密码的特定用户流来处理此错误代码。 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/active-directory-b2c/user-flow-overview#linking-user-flows">Microsoft Docs：user flow 概述</a></p>
<h4 id="注册Api应用程序"><a href="#注册Api应用程序" class="headerlink" title="注册Api应用程序"></a>注册Api应用程序</h4><p>将访问受控的应用(这里是Web Api)注册到Azure AD B2C，框架给予应用程序client id等标记，记下当登录成功时跳转回的地址————Redirect URI(关于Redirect URI的限制见本文Q&amp;A部分)。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Display name:Demo website</span><br><span class="line">Application (client) ID:c4b27029-a5ad-4022-979d-8721101df951</span><br><span class="line">Directory (tenant) ID:9175ffa9-24b3-4fc1-806e-6d53582a7f4f</span><br><span class="line">Object ID:c5064a61-0321-4a39-9f3c-dcef0df9b99c</span><br><span class="line">Supported account types:All Microsoft  users</span><br><span class="line">Redirect URIs:1 web, 0 spa, 0 public client</span><br><span class="line">Application ID URI:Add an Application ID URI</span><br><span class="line">Managed application in local directory:Demo website</span><br></pre></td></tr></table></figure><br>这里的Redireact URI是<a target="_blank" rel="noopener" href="http://localhost:8888/auth，期望在本机运行桌面客户端程序，访问Api跳转到Azure">http://localhost:8888/auth，期望在本机运行桌面客户端程序，访问Api跳转到Azure</a> Page登录，成功后进入到该地址。<br><br>进入管理—认证(Authentication),选择使用<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/active-directory/develop/v2-oauth2-implicit-grant-flow?WT.mc_id=Portal-Microsoft_AAD_RegisteredApps">隐式授权流</a>(Implicit grant, 见笔记<a href="/qqsnote/2019/12/09/OAuth2/" title="OAuth2">OAuth2</a>), 并添加Redirect Uri<br><br><img src="https://i0.wp.com/tvax3.sinaimg.cn/large/a60edd42gy1ggqjztlsc1j21820oyadq.jpg" alt="04register_app_add_auth_url"><br>进入管理—公开API(expose API),Application ID URI set 为<a target="_blank" rel="noopener" href="https://qqstudio.onmicrosoft.com/api">https://qqstudio.onmicrosoft.com/api</a> 默认是由GUID组成的<br><br>添加scope(Add a scope)<br><img src="https://i0.wp.com/tvax3.sinaimg.cn/large/a60edd42gy1ggqjzvx048j21hc0smtch.jpg" alt="05add access scope"><br>scope是控制访问权限的定义，将在后续步骤中被授权到已注册的client<br></p>
</blockquote>
<h4 id="配置Web-Api应用的Authorization"><a href="#配置Web-Api应用的Authorization" class="headerlink" title="配置Web Api应用的Authorization"></a>配置Web Api应用的Authorization</h4><p>使Web Api能将token拿到Azure AD B2C去校验，官方Sample中从config.js读取配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const config &#x3D; &#123;</span><br><span class="line">    identityMetadata: &quot;https:&#x2F;&#x2F;&quot; + b2cDomainHost + &quot;&#x2F;&quot; + tenantId + &quot;&#x2F;&quot; + policyName + &quot;&#x2F;v2.0&#x2F;.well-known&#x2F;openid-configuration&#x2F;&quot;,</span><br><span class="line">    clientID: clientID,</span><br><span class="line">    policyName: policyName,</span><br><span class="line">    isB2C: true,</span><br><span class="line">    validateIssuer: false,</span><br><span class="line">    loggingLevel: &#39;info&#39;,</span><br><span class="line">    loggingNoPII: false,</span><br><span class="line">    passReqToCallback: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>express web api的认证和重定向用到了<a target="_blank" rel="noopener" href="https://github.com/jaredhanson/passport">passport</a>和<a target="_blank" rel="noopener" href="https://github.com/AzureAD/passport-azure-ad#readme">passport-azure-ad</a>两个包，后者直接带入上面的config对象做为参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">const express &#x3D; require(&quot;express&quot;);</span><br><span class="line">const morgan &#x3D; require(&quot;morgan&quot;);</span><br><span class="line">const passport &#x3D; require(&quot;passport&quot;);</span><br><span class="line">const config &#x3D; require(&#39;.&#x2F;config&#39;);</span><br><span class="line">const BearerStrategy &#x3D; require(&#39;passport-azure-ad&#39;).BearerStrategy;</span><br><span class="line"></span><br><span class="line">const bearerStrategy &#x3D; new BearerStrategy(config,</span><br><span class="line">    function (token, done) &#123;</span><br><span class="line">        &#x2F;&#x2F; Send user info using the second argument</span><br><span class="line">        done(null, &#123;&#125;, token);</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">const app &#x3D; express();</span><br><span class="line"></span><br><span class="line">app.use(morgan(&#39;dev&#39;));</span><br><span class="line">app.use(passport.initialize());</span><br><span class="line"></span><br><span class="line">passport.use(bearerStrategy);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;enable CORS</span><br><span class="line">app.use((req, res, next) &#x3D;&gt; &#123;</span><br><span class="line">    res.header(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span><br><span class="line">    res.header(&quot;Access-Control-Allow-Headers&quot;, &quot;Authorization, Origin, X-Requested-With, Content-Type, Accept&quot;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; API endpoint</span><br><span class="line">app.get(&quot;&#x2F;hello&quot;,</span><br><span class="line">    passport.authenticate(&#39;oauth-bearer&#39;, &#123;session: false&#125;),</span><br><span class="line">    (req, res) &#x3D;&gt; &#123;</span><br><span class="line">        console.log(&#39;User info: &#39;, req.user);</span><br><span class="line">        console.log(&#39;Validated claims: &#39;, req.authInfo);</span><br><span class="line">        </span><br><span class="line">        if (&#39;scp&#39; in req.authInfo &amp;&amp; req.authInfo[&#39;scp&#39;].split(&quot; &quot;).indexOf(&quot;demo.read&quot;) &gt;&#x3D; 0) &#123;</span><br><span class="line">            &#x2F;&#x2F; Service relies on the name claim.  </span><br><span class="line">            res.status(200).json(&#123;&#39;name&#39;: req.authInfo[&#39;name&#39;]&#125;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            console.log(&quot;Invalid Scope, 403&quot;);</span><br><span class="line">            res.status(403).json(&#123;&#39;error&#39;: &#39;insufficient_scope&#39;&#125;); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">const port &#x3D; process.env.PORT || 5000;</span><br><span class="line"></span><br><span class="line">app.listen(port, () &#x3D;&gt; &#123;</span><br><span class="line">    console.log(&quot;Listening on port &quot; + port);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="注册客户端程序"><a href="#注册客户端程序" class="headerlink" title="注册客户端程序"></a>注册客户端程序</h4><p>将官网sample的wpf client注册到Azure AD B2C<br><br>创建完成后添加Api权限，或者说授权scope：管理—API权限(API Permission)—Add a permission—My APIs,选择已注册的Web API应用<br><img src="https://i0.wp.com/tvax1.sinaimg.cn/large/a60edd42gy1ggqjzx4r8ij21hc0smadq.jpg" alt="06 add client api permissions"><br>勾选Permissions，即上文中的scopes<br><img src="https://i0.wp.com/tvax4.sinaimg.cn/large/a60edd42gy1ggqjzyald0j21hc0smgqd.jpg" alt="07 select permissions"><br>授权client使用scope：管理—API权限(API Permission)—Grant admin consent for xxxx(telent Name)—click Yes<br><br>QQs跟随sample的步骤遗漏了下面这一步————添加重定向地址————导致在配置客户端时Redirect Uri不知道填什么<br><br>管理—Authentication—Add a platform—Mobile and desktop applications 然后可以看到根据当前talent的user flow生成的登录页模板 勾选<a target="_blank" rel="noopener" href="https://qqstudio.b2clogin.com/oauth2/nativeclient">https://qqstudio.b2clogin.com/oauth2/nativeclient</a><br><img src="https://i0.wp.com/tvax3.sinaimg.cn/large/a60edd42gy1ggqjzzhlnwj21hc0sm79k.jpg" alt="08 client redirect to login page"></p>
<h4 id="配置客户端以访问已授权的Api"><a href="#配置客户端以访问已授权的Api" class="headerlink" title="配置客户端以访问已授权的Api"></a>配置客户端以访问已授权的Api</h4><p>sample client是个WPF应用，引入了Microsoft.Identity.Client这个包来进行token校验<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Copyright (c) Microsoft Corporation. All rights reserved.</span><br><span class="line">&#x2F;&#x2F; Licensed under the MIT License.</span><br><span class="line"></span><br><span class="line">using System.IO;</span><br><span class="line">using System.Text;</span><br><span class="line">using System.Windows;</span><br><span class="line">using Microsoft.Identity.Client;</span><br><span class="line"></span><br><span class="line">namespace active_directory_b2c_wpf</span><br><span class="line">&#123;</span><br><span class="line">    public partial class App : Application</span><br><span class="line">    &#123;</span><br><span class="line">        private static readonly string Tenant &#x3D; &quot;61874450-1725-44bb-bb8e-314575861ad6&quot;;</span><br><span class="line">        private static readonly string AzureAdB2CHostname &#x3D; &quot;https:&#x2F;&#x2F;qqstudio.b2clogin.com&#x2F;oauth2&#x2F;nativeclient&quot;;</span><br><span class="line">        private static readonly string ClientId &#x3D; &quot;8e039329-171a-4484-8151-4e67bf561218&quot;; &#x2F;&#x2F; 这里的clientId是WPF Client自己的ID</span><br><span class="line">        private static readonly string RedirectUri &#x3D; &quot;https:&#x2F;&#x2F;fabrikamb2c.b2clogin.com&#x2F;oauth2&#x2F;nativeclient&quot;; &#x2F;&#x2F; 这个是Azure给桌面客户端的登录页</span><br><span class="line">        public static string PolicySignUpSignIn &#x3D; &quot;B2C_1_basic_sign_up_and_sign_in&quot;;</span><br><span class="line"></span><br><span class="line">        public static string[] ApiScopes &#x3D; &#123; &quot;https:&#x2F;&#x2F;qqstudio.onmicrosoft.com&#x2F;api&#x2F;demo.read&quot;, &quot;https:&#x2F;&#x2F;qqstudio.onmicrosoft.com&#x2F;api&#x2F;demo.write&quot; &#125;;</span><br><span class="line">        public static string ApiEndpoint &#x3D; &quot;https:&#x2F;&#x2F;fabrikamb2chello.azurewebsites.net&#x2F;hello&quot;;</span><br><span class="line">        private static string AuthorityBase &#x3D; $&quot;https:&#x2F;&#x2F;&#123;AzureAdB2CHostname&#125;&#x2F;tfp&#x2F;&#123;Tenant&#125;&#x2F;&quot;;</span><br><span class="line">        public static string AuthoritySignUpSignIn &#x3D; $&quot;&#123;AuthorityBase&#125;&#123;PolicySignUpSignIn&#125;&quot;;</span><br><span class="line"></span><br><span class="line">        public static IPublicClientApplication PublicClientApp &#123; get; private set; &#125;</span><br><span class="line"></span><br><span class="line">        static App()</span><br><span class="line">        &#123;</span><br><span class="line">            PublicClientApp &#x3D; PublicClientApplicationBuilder.Create(ClientId)</span><br><span class="line">            .WithB2CAuthority(AuthoritySignUpSignIn)</span><br><span class="line">            .WithRedirectUri(RedirectUri)</span><br><span class="line">            .WithLogging(Log, LogLevel.Info, false) &#x2F;&#x2F; don&#39;t log PII details on a regular basis</span><br><span class="line">            .Build();</span><br><span class="line"></span><br><span class="line">            TokenCacheHelper.Bind(PublicClientApp.UserTokenCache);</span><br><span class="line">        &#125;</span><br><span class="line">        private static void Log(LogLevel level, string message, bool containsPii)</span><br><span class="line">        &#123;</span><br><span class="line">            string logs &#x3D; ($&quot;&#123;level&#125; &#123;message&#125;&quot;);</span><br><span class="line">            StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line">            sb.Append(logs);</span><br><span class="line">            File.AppendAllText(System.Reflection.Assembly.GetExecutingAssembly().Location + &quot;.msalLogs.txt&quot;, sb.ToString());</span><br><span class="line">            sb.Clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="scopes"><a href="#scopes" class="headerlink" title="scopes"></a>scopes</h4><p>通过scopes管理对受保护资源的权限，请求令牌时，客户端传递scope</p>
<h4 id="关于校验和跳转的包的实现的推测"><a href="#关于校验和跳转的包的实现的推测" class="headerlink" title="关于校验和跳转的包的实现的推测"></a>关于校验和跳转的包的实现的推测</h4><ul>
<li>客户端访问api，Http/Https Request</li>
<li>客户端Request使用Jwt Bearer Authentication 传递token<br><img src="https://i0.wp.com/tvax4.sinaimg.cn/large/a60edd42gy1ghejipxhdkj213f0cmjru.jpg" alt="10 bearer auth"></li>
<li>服务端接收到的request中token缺少或过期，返回401</li>
<li>客户端收到401打开Azure Sign in Page，附带重定向回api end point 的url</li>
<li>Azure AD 框架进行认证</li>
<li>Azure AD 框架查询并授权 颁发相应的token</li>
<li>客户端接收到token并缓存<h4 id="自定义策略用户流"><a href="#自定义策略用户流" class="headerlink" title="自定义策略用户流"></a>自定义策略用户流</h4>使用ADB2C认证授权流可选择预置的User flow（见上文）或自定义策略</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/active-directory-b2c/tutorial-create-user-flows?pivots=b2c-custom-policy#add-signing-and-encryption-keys-for-identity-experience-framework-applications">Microsoft Docs：为 Identity Experience Framework 应用程序添加签名和加密密钥</a></p>
<p><a target="_blank" rel="noopener" href="https://tsmatz.wordpress.com/2020/05/12/azure-ad-b2c-ief-custom-policy-walkthrough/">A Walkthrough For Azure AD B2C Custom Policy (Identity Experience Framework)</a></p>
<p>下载新手配置包（<a target="_blank" rel="noopener" href="https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack.git">starterpack</a>）</p>
<h4 id="移动客户端Android"><a href="#移动客户端Android" class="headerlink" title="移动客户端Android"></a>移动客户端Android</h4><p>Redierct Uri形如 msauth://{PACKAGE_NAME}/{BASE64_URL_ENCODED_PACKAGE_SIGNATURE}<br>将React Native应用注册为ADB2C的客户端：<br>Azure Portal -&gt; ADB2C -&gt; App registration -&gt; Authentication -&gt; Platform configurations -&gt; Add a platform -&gt; Android</p>
<ul>
<li>PACKAGE_NAME /android/app/src/main/java/com/exampleapp/MainApplication.kt 从路径以及java源码的顶层包名可知，此处为 <strong>com.exampleapp</strong></li>
<li>SIGNATURE 生成签名↓<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -exportcert -alias androiddebugkey -keystore %HOMEPATH%\.android\debug.keystore | openssl sha1 -binary | openssl base64</span><br></pre></td></tr></table></figure>
<h4 id="移动客户端ios"><a href="#移动客户端ios" class="headerlink" title="移动客户端ios"></a>移动客户端ios</h4>Redirect Urix形如msauth.{BUNDLE_ID}://auth<br>同上Add a platform for iOS/macOS并填入BUNDLE_ID<br>事实上BUNDLE_ID也是如com.exampleapp的字符串</li>
</ul>
<h4 id="使用Azure-AD-作为identity-provider（存目）"><a href="#使用Azure-AD-作为identity-provider（存目）" class="headerlink" title="使用Azure AD 作为identity provider（存目）"></a>使用Azure AD 作为identity provider（存目）</h4><p>以实现一键(使用AD凭据)登录</p>
<h4 id="对接wechat-作为identity-provider（存目）"><a href="#对接wechat-作为identity-provider（存目）" class="headerlink" title="对接wechat 作为identity provider（存目）"></a>对接wechat 作为identity provider（存目）</h4><p>在user flow - identity provider中勾选社交账号 wechat</p>
<h4 id="关于系统角色定义"><a href="#关于系统角色定义" class="headerlink" title="关于系统角色定义"></a>关于系统角色定义</h4><p>多个系统使用Azure AD B2C，各个系统地权限角色是否要在Azure方维护呢？是否是在expose API时定义scope呢？<br><br>私以为并不是，鉴于<a href="/qqsnote/2019/12/09/OAuth2/" title="OAuth">OAuth</a>一篇中所述，资源服务器保留私钥对access token进行校验，甚至可以从中解析出当前用户key，过期时间等信息，籍此完全可以查询本系统定义地权限角色，而无须频繁访问SSO。</p>
<h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><blockquote>
<p>issue: The application associated with client id has no registered redirect URIs.</p>
</blockquote>
<p>按说在App Registry中配置 Redirect URI是optional的，曾遇到此问题是没有勾选隐式授权（Authentication—&gt;Implicit grant）</p>
<blockquote>
<p>一定需要注册Redirect URI吗，可以在跳转到登录页时作为query parameter传递吗？</p>
</blockquote>
<p>一定要注册, 似乎是出于复杂的安全性的考虑 见<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/47520604/why-is-redirect-url-fully-qualified-in-azure-ad-b2c">StackOverflow:Why is Redirect URL Fully Qualified in Azure AD B2C?
</a><br>跳转到登录页时确实会传递Redirect_URI参数，否则会报redirect_uri_mismatch的Error且不会传回access token<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/active-directory/develop/reply-url">Redirect Uri 的限制</a>要求作为跳转参数的Redirect_URI，与注册在ADB2C上的若干Redirect URIs之一完全匹配，除了localhost(匹配时自动忽略端口)。<br>官方文档还提到了state参数，跳转参数state将在登录成功后链在Redirect URI后面，可以用来恢复跳转登录前的浏览状态</p>
<blockquote>
<p>Silent Sign In Workflow</p>
</blockquote>
<h4 id="自定义登录页"><a href="#自定义登录页" class="headerlink" title="自定义登录页"></a>自定义登录页</h4><p>参考<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/active-directory-b2c/customize-ui?pivots=b2c-user-flow">Microsoft Docs: ADB2C UX自定义</a><br>可设置蓝色 灰色 经典风格的sign in页面 以及公司logo<br>设置表单项目及排序等</p>
<h4 id="Wechat"><a href="#Wechat" class="headerlink" title="Wechat"></a>Wechat</h4><p>首先是在<a target="_blank" rel="noopener" href="https://open.weixin.qq.com/cgi-bin/applist?t=manage/list&amp;page=0&amp;num=20&amp;openapptype=512&amp;token=046ef0026c9a457aa1f8f33db6868c26e193c21d&amp;lang=zh_CN">微信公众平台</a>注册网站应用,注册过程需要填写企业/个人网站的官网和备案号，很头疼</p>
<p>添加Wechat为AB B2C的identity provider：Azure AD B2C —&gt; Identity providers —&gt; WeChat(Preview) 可以看到Callback URL(填到微信公众平台上注册的网站应用的授权回调域配置中)，Name可以填WeChat，填写网站应用的id/secret</p>
<p>添加identity provider到User flow：Azure AD B2C —&gt; User flows —&gt; [Your User flow] —&gt; Identity providers 选择已添加到AD B2C的 social identity provider</p>
<h4 id="多个资源"><a href="#多个资源" class="headerlink" title="多个资源"></a>多个资源</h4><blockquote>
<p>issue: MSAL AADB2C90146 ‘Openid profile’ provided in request specifies more than one resource for an access token, which is not supported’</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/49362631/msal-aadb2c90146-openid-profile-provided-in-request-specifies-more-than-on">stackoverflow: use requestsilent</a></p>
<h4 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h4><ul>
<li><a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=AzureADB2CTools.aadb2c">Visual Studio Code 的 Azure AD B2C 扩展</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/active-directory-b2c/troubleshoot-with-application-insights">Application Insights-logs</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qqstone.github.io/qqsnote/2020/06/29/React/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/qqsnote/images/avatar.gif">
      <meta itemprop="name" content="QQs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QQs'Note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/qqsnote/2020/06/29/React/" class="post-title-link" itemprop="url">React</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-29 16:18:41" itemprop="dateCreated datePublished" datetime="2020-06-29T16:18:41+08:00">2020-06-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-11-11 10:42:27" itemprop="dateModified" datetime="2025-11-11T10:42:27+08:00">2025-11-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="JSX模板"><a href="#JSX模板" class="headerlink" title="JSX模板"></a>JSX模板</h4><p>以.jsx为后缀的标记文件，用以书写混合js逻辑的dom模板<br>example.jsx, jsx文件经Babel编译为js运行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> JSX = (</span><br><span class="line">  &lt;div className=<span class="string">&quot;myDiv&quot;</span>&gt;</span><br><span class="line">    &lt;h1&gt;Hello World&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;Lets render <span class="built_in">this</span> to the DOM&lt;/p&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line">ReactDOM.render(JSX,<span class="built_in">document</span>.getElementById(<span class="string">&quot;challenge-node&quot;</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>用{}包含js代码，包括变量和相应方法</li>
<li>用className绑定class样式</li>
</ul>
<p>除了jsx标记之外，还有createElement创建React组件的方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">const</span> element = React.createElement(<span class="string">&#x27;div&#x27;</span>, &#123; <span class="attr">className</span>: <span class="string">&#x27;greeting&#x27;</span> &#125;, <span class="string">&#x27;Hello World!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//引用</span></span><br><span class="line">&lt;element /&gt;</span><br></pre></td></tr></table></figure>
<h4 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h4><p>use the syntax {/**/}</p>
<h4 id="表单"><a href="#表单" class="headerlink" title="表单"></a>表单</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;form onSubmit=&#123;<span class="built_in">this</span>.handleSubmit&#125;&gt;</span><br><span class="line">      &lt;label&gt;</span><br><span class="line">        文章:</span><br><span class="line">        &lt;textarea value=&#123;<span class="built_in">this</span>.state.value&#125; onChange=&#123;<span class="built_in">this</span>.handleChange&#125; /&gt;</span><br><span class="line">      &lt;/label&gt;</span><br><span class="line">      &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span> /&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ES6语法"><a href="#ES6语法" class="headerlink" title="ES6语法"></a>ES6语法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;Here is Entry&lt;/h1&gt;</span><br><span class="line">        &#123;<span class="comment">/* 子组件 */</span>&#125;</span><br><span class="line">        &lt;ChildComponent /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ChildComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;I am the child&lt;/p&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>, <span class="built_in">document</span>.getElementById(<span class="string">&quot;app&quot;</span>)) </span><br></pre></td></tr></table></figure>
<h4 id="子组件传参"><a href="#子组件传参" class="headerlink" title="子组件传参"></a>子组件传参</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CurrentDate = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;The current date is: &#123;props.date&#125;&lt;/p&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> Data = <span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Calendar</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h3&gt;What date is it?&lt;/h3&gt;</span><br><span class="line">        &lt;CurrentDate date=&#123;<span class="built_in">Date</span>()&#125;/&gt;</span><br><span class="line">        &lt;p&gt;&#123;<span class="built_in">this</span>.props.name&#125;&lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>使用函数表达式不需要this指针而class定义是要的(ES6 ()=&gt;{}不创建this)</p>
<p>另外设置默认参数：ComponentA.defaultProps = {name:’New Component’}</p>
<p>更多组件通信见<a href="/qqsnote/2021/01/28/React-ComponentCommunicate/" title="React组件交互">React组件交互</a></p>
<h4 id="参数校验"><a href="#参数校验" class="headerlink" title="参数校验"></a>参数校验</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">MyComponent.propTypes = &#123;</span><br><span class="line">  <span class="comment">// 你可以将属性声明为 JS 原生类型，默认情况下</span></span><br><span class="line">  <span class="comment">// 这些属性都是可选的。</span></span><br><span class="line">  optionalArray: PropTypes.array,</span><br><span class="line">  optionalBool: PropTypes.bool,</span><br><span class="line">  optionalFunc: PropTypes.func,</span><br><span class="line">  optionalNumber: PropTypes.number,</span><br><span class="line">  optionalObject: PropTypes.object,</span><br><span class="line">  optionalString: PropTypes.string,</span><br><span class="line">  optionalSymbol: PropTypes.symbol,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 任何可被渲染的元素（包括数字、字符串、元素或数组）</span></span><br><span class="line">  <span class="comment">// (或 Fragment) 也包含这些类型。</span></span><br><span class="line">  optionalNode: PropTypes.node,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一个 React 元素。</span></span><br><span class="line">  optionalElement: PropTypes.element,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一个 React 元素类型（即，MyComponent）。</span></span><br><span class="line">  optionalElementType: PropTypes.elementType,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 你也可以声明 prop 为类的实例，这里使用</span></span><br><span class="line">  <span class="comment">// JS 的 instanceof 操作符。</span></span><br><span class="line">  optionalMessage: PropTypes.instanceOf(Message),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 你可以让你的 prop 只能是特定的值，指定它为</span></span><br><span class="line">  <span class="comment">// 枚举类型。</span></span><br><span class="line">  optionalEnum: PropTypes.oneOf([<span class="string">&#x27;News&#x27;</span>, <span class="string">&#x27;Photos&#x27;</span>]),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一个对象可以是几种类型中的任意一个类型</span></span><br><span class="line">  optionalUnion: PropTypes.oneOfType([</span><br><span class="line">    PropTypes.string,</span><br><span class="line">    PropTypes.number,</span><br><span class="line">    PropTypes.instanceOf(Message)</span><br><span class="line">  ]),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 可以指定一个数组由某一类型的元素组成</span></span><br><span class="line">  optionalArrayOf: PropTypes.arrayOf(PropTypes.number),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 可以指定一个对象由某一类型的值组成</span></span><br><span class="line">  optionalObjectOf: PropTypes.objectOf(PropTypes.number),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 可以指定一个对象由特定的类型值组成</span></span><br><span class="line">  optionalObjectWithShape: PropTypes.shape(&#123;</span><br><span class="line">    color: PropTypes.string,</span><br><span class="line">    fontSize: PropTypes.number</span><br><span class="line">  &#125;),</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// An object with warnings on extra properties</span></span><br><span class="line">  optionalObjectWithStrictShape: PropTypes.exact(&#123;</span><br><span class="line">    name: PropTypes.string,</span><br><span class="line">    quantity: PropTypes.number</span><br><span class="line">  &#125;),   </span><br><span class="line"></span><br><span class="line">  <span class="comment">// 你可以在任何 PropTypes 属性后面加上 `isRequired` ，确保</span></span><br><span class="line">  <span class="comment">// 这个 prop 没有被提供时，会打印警告信息。</span></span><br><span class="line">  requiredFunc: PropTypes.func.isRequired,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 任意类型的数据</span></span><br><span class="line">  requiredAny: PropTypes.any.isRequired,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 你可以指定一个自定义验证器。它在验证失败时应返回一个 Error 对象。</span></span><br><span class="line">  <span class="comment">// 请不要使用 `console.warn` 或抛出异常，因为这在 `onOfType` 中不会起作用。</span></span><br><span class="line">  customProp: <span class="function"><span class="keyword">function</span>(<span class="params">props, propName, componentName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="regexp">/matchme/</span>.test(props[propName])) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">&#x27;Invalid prop `&#x27;</span> + propName + <span class="string">&#x27;` supplied to&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27; `&#x27;</span> + componentName + <span class="string">&#x27;`. Validation failed.&#x27;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 你也可以提供一个自定义的 `arrayOf` 或 `objectOf` 验证器。</span></span><br><span class="line">  <span class="comment">// 它应该在验证失败时返回一个 Error 对象。</span></span><br><span class="line">  <span class="comment">// 验证器将验证数组或对象中的每个值。验证器的前两个参数</span></span><br><span class="line">  <span class="comment">// 第一个是数组或对象本身</span></span><br><span class="line">  <span class="comment">// 第二个是他们当前的键。</span></span><br><span class="line">  customArrayProp: PropTypes.arrayOf(<span class="function"><span class="keyword">function</span>(<span class="params">propValue, key, componentName, location, propFullName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="regexp">/matchme/</span>.test(propValue[key])) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">&#x27;Invalid prop `&#x27;</span> + propFullName + <span class="string">&#x27;` supplied to&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27; `&#x27;</span> + componentName + <span class="string">&#x27;`. Validation failed.&#x27;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/typechecking-with-proptypes.html#requiring-single-child">使用 PropTypes 进行类型检查</a></p>
<h4 id="state及组件生命周期"><a href="#state及组件生命周期" class="headerlink" title="state及组件生命周期"></a>state及组件生命周期</h4><p>&gt;</p>
<blockquote>
<p>props是父组件传入的只读参数，state是组件自身的动态的状态</p>
<p>为了正确地构建组件，需要找出组件模型所需的 state 的最小表示，其他所有数据根据该state计算出。<a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/thinking-in-react.html#step-3-identify-the-minimal-but-complete-representation-of-ui-state">React哲学</a><br>props是传入参数，而state是组件内部表征状态的对象，往往在构造函数中，根据props初始化state</p>
</blockquote>
<p>组件状态更新使用setState，函数触发组件的重新渲染</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Clock</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="comment">// 初始化date为当前时间</span></span><br><span class="line">    <span class="built_in">this</span>.state = &#123;<span class="attr">date</span>: <span class="keyword">new</span> <span class="built_in">Date</span>()&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* 加载 */</span></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 1s后开始跳</span></span><br><span class="line">    <span class="built_in">this</span>.timerID = <span class="built_in">setInterval</span>(</span><br><span class="line">      () =&gt; <span class="built_in">this</span>.tick(),</span><br><span class="line">      <span class="number">1000</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* 卸载 */</span></span><br><span class="line">  <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">clearInterval</span>(<span class="built_in">this</span>.timerID);</span><br><span class="line">  &#125;</span><br><span class="line">  tick=<span class="function">()=&gt;</span>&#123;<span class="built_in">this</span>.setState(<span class="function">(<span class="params">pre</span>)=&gt;</span>(&#123;<span class="attr">date</span>:<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;))&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;Hello, world!&lt;/h1&gt;</span><br><span class="line">        &lt;h2&gt;It is &#123;<span class="built_in">this</span>.state.date.toLocaleTimeString()&#125;.&lt;/h2&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="bind-‘this’"><a href="#bind-‘this’" class="headerlink" title="bind ‘this’"></a>bind ‘this’</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      text: <span class="string">&quot;Hello&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">this</span>.handleClick = <span class="built_in">this</span>.handleClick.bind(<span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">handleClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      text: <span class="string">&quot;You clicked!&quot;</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="built_in">this</span>.handleClick&#125;&gt;Click Me&lt;/button&gt;</span><br><span class="line">        &lt;h1&gt;&#123;<span class="built_in">this</span>.state.text&#125;&lt;/h1&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>为什么要bind(this) 因为在严格模式下(React内部执行严格模式)函数在对象外被调用时 this 并不指向对象，事实上React组件的响应方法不‘生成’this(即undefined) 这与非严格模式下的html原生事件响应不同(非严格模式下事件会指向window) 原因在于React事件并不真实作用于dom节点，而是编译时生成的独立响应树(事件委托机制)</p>
<p>如果handleClick需要处理组件属性 必须onClick={this.handleClick.bind(this)} 或在构造方法中提前绑定</p>
<h4 id="条件渲染"><a href="#条件渲染" class="headerlink" title="条件渲染"></a>条件渲染</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> isLoggedIn = <span class="built_in">this</span>.state.isLoggedIn;</span><br><span class="line">  <span class="keyword">let</span> button;</span><br><span class="line">  <span class="keyword">if</span> (isLoggedIn) &#123;</span><br><span class="line">    button = <span class="xml"><span class="tag">&lt;<span class="name">LogoutButton</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleLogoutClick&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    button = <span class="xml"><span class="tag">&lt;<span class="name">LoginButton</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleLoginClick&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Greeting isLoggedIn=&#123;isLoggedIn&#125; /&gt;</span><br><span class="line">      &#123;button&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与运算&amp;&amp;</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;flag &amp;&amp; <span class="xml"><span class="tag">&lt;<span class="name">toggleComponent</span> /&gt;</span></span>&#125;</span><br></pre></td></tr></table></figure>
<p>三目运算</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> isLoggedIn = <span class="built_in">this</span>.state.isLoggedIn;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Greeting isLoggedIn=&#123;isLoggedIn&#125; /&gt;</span><br><span class="line">      &#123;isLoggedIn?<span class="xml"><span class="tag">&lt;<span class="name">LogoutButton</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleLogoutClick&#125;</span> /&gt;</span></span>:<span class="xml"><span class="tag">&lt;<span class="name">LoginButton</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleLoginClick&#125;</span> /&gt;</span></span>&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h4><p>没有继承！</p>
<blockquote>
<p>在render return中组合子组件提供了清晰而安全地定制组件外观和行为的灵活方式，没有需要使用继承来构建组件层次的情况。<a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/composition-vs-inheritance.html#so-what-about-inheritance">React Docs:组合 vs 继承</a></p>
<h4 id="createRef-onRef-useRef"><a href="#createRef-onRef-useRef" class="headerlink" title="createRef onRef useRef"></a>createRef onRef useRef</h4></blockquote>
<p>子组件实例化回调函数，用以获取子组件对象</p>
<blockquote>
<p>useRef 仅能用在 FunctionComponent，createRef 仅能用在 ClassComponent。</p>
</blockquote>
<p><strong>组件的对象会随组件的更新而刷新，但useRef返回的对象不会随着组件的更新而重新构建，像引入的全局变量，且随组件的销毁而释放，不需手动销毁</strong></p>
<h4 id="Fragment"><a href="#Fragment" class="headerlink" title="Fragment"></a>Fragment</h4><p>相当于Angular的template，插入子组件不生成额外的元素(如div)，<React.Fragment></React.Fragment>可以省略为<></></p>
<h4 id="ReactDOMServer"><a href="#ReactDOMServer" class="headerlink" title="ReactDOMServer"></a>ReactDOMServer</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>/&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">ReactDOMServer.renderToString(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>);</span><br></pre></td></tr></table></figure>
<p>服务端渲染(SSR),生成dom的html字符串,实现SEO优化</p>
<h4 id="Create-React-App"><a href="#Create-React-App" class="headerlink" title="Create React App"></a>Create React App</h4><p>这是一个package <a target="_blank" rel="noopener" href="https://create-react-app.dev/docs/getting-started">create-react-app</a>, 如angular-cli，和vue-cli中包含的命令工具(这里封装的命令是react-scripts, 见package.json中的scripts)，用以创建基于React的完整应用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">my-app/</span><br><span class="line">  node_modules/</span><br><span class="line">  public/</span><br><span class="line">    index.html</span><br><span class="line">    favicon.ico</span><br><span class="line">  src/</span><br><span class="line">    App.css</span><br><span class="line">    App.js</span><br><span class="line">    App.test.js</span><br><span class="line">    index.css</span><br><span class="line">    index.js</span><br><span class="line">    logo.svg</span><br><span class="line">  README.md</span><br><span class="line">  package.json</span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">`js</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### 关于typescript</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br><span class="line">yarn add --dev typescript</span><br></pre></td></tr></table></figure>
<p>在tsconfig.json中配置typescript编译器(<a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/static-type-checking.html#configuring-the-typescript-compiler">略</a>)</p>
<p>使用tsx文件书写包含jsx代码的typescript代码</p>
<p>使用tsc命令编译</p>
<p>添加@types/react, vs code 右下角TypeScript版本选择4.<em>.</em>-pnpify</p>
<h4 id="list"><a href="#list" class="headerlink" title="list"></a>list</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ArrayComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> array = [<span class="string">&#x27;John&#x27;</span>, <span class="string">&#x27;Robbie&#x27;</span>, <span class="string">&#x27;Tony&#x27;</span>]</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">    &#123;array.map(<span class="function">(<span class="params">name, index</span>)=&gt;</span><span class="xml"><span class="tag">&lt;<span class="name">Item</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span> &gt;</span>&#123;name&#125;<span class="tag">&lt;/<span class="name">Item</span>&gt;</span></span>)&#125;</span><br><span class="line">    &lt;&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">`js</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">需要指出的是 key 并不是 Item定义的Props，在Item组件内部访问key会得到undefined</span></span><br><span class="line"><span class="string">[Github Issue:</span></span><br><span class="line"><span class="string">this.key seems to always be undefined inside a React component</span></span><br><span class="line"><span class="string">](https://github.com/facebook/react/issues/2429#issuecomment-61008642)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#### Interview Questions</span></span><br><span class="line"><span class="string">&gt;</span></span><br><span class="line"><span class="string">&gt; 类组件 vs 函数组件</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt; props不可变性</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt; React hook 闭包陷阱</span></span><br><span class="line"><span class="string">闭包内缓存state 导致定时器时间间隔内取到的都是上一次的值</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> handleClick = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      setCount(count + <span class="number">1</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> handleReset = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    setCount(<span class="number">0</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;Count: &#123;count&#125;&lt;/p&gt;</span><br><span class="line">      &lt;button onClick=&#123;handleClick&#125;&gt;Increment&lt;/button&gt;</span><br><span class="line">      &lt;button onClick=&#123;handleReset&#125;&gt;Reset&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setCount(count =&gt; (count + 1))可以避免</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qqstone.github.io/qqsnote/2020/06/24/ef-migration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/qqsnote/images/avatar.gif">
      <meta itemprop="name" content="QQs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QQs'Note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/qqsnote/2020/06/24/ef-migration/" class="post-title-link" itemprop="url">Entity Framework Migration</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-24 12:36:53" itemprop="dateCreated datePublished" datetime="2020-06-24T12:36:53+08:00">2020-06-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-05 10:07:52" itemprop="dateModified" datetime="2025-07-05T10:07:52+08:00">2025-07-05</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/ef/core/managing-schemas/migrations/">tourial</a></p>
<h4 id="安装dotnet-ef-cli"><a href="#安装dotnet-ef-cli" class="headerlink" title="安装dotnet ef cli"></a>安装dotnet ef cli</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet tool install --global dotnet-ef</span><br></pre></td></tr></table></figure>
<h4 id="创建‘迁移’"><a href="#创建‘迁移’" class="headerlink" title="创建‘迁移’"></a>创建‘迁移’</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef migrations add QQsInitialCreate</span><br></pre></td></tr></table></figure>
<blockquote>
<p>issue: No project was found. Change the current working directory or use the —project option.</p>
</blockquote>
<p>项目入口(startup)的csproj与models目录分离，如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">├───MyProduct.API</span><br><span class="line">│   └───startup.cs</span><br><span class="line">└───MyProduct.Models</span><br><span class="line">    └───migrations</span><br></pre></td></tr></table></figure><br>定位startup project：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd MyProduct.Models</span><br><span class="line">dotnet ef migrations add QQsInitialCreate --startup-project &quot;D:\QQsWorkspace\MyProduct.API&quot;</span><br></pre></td></tr></table></figure><br>更新数据库(—startup-project参数略)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef database update</span><br></pre></td></tr></table></figure><br>参考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/ef/core/cli/dotnet">Microsoft Docs:Entity Framework Core 工具</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qqstone.github.io/qqsnote/2020/06/15/entityframework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/qqsnote/images/avatar.gif">
      <meta itemprop="name" content="QQs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QQs'Note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/qqsnote/2020/06/15/entityframework/" class="post-title-link" itemprop="url">Entity Framework</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-15 16:39:32" itemprop="dateCreated datePublished" datetime="2020-06-15T16:39:32+08:00">2020-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-05 10:07:52" itemprop="dateModified" datetime="2025-07-05T10:07:52+08:00">2025-07-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/qqsnote/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">后端技术</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>EntirtyFramework框架是一个轻量级的可扩展版本的流行实体框架数据访问技术,ORM工具(Object Relational Mapping 对象关系映射)</p>
</blockquote>
<p>EF有三种使用场景，1. 从数据库生成Class(DB First)，2.由实体类生成数据库表结构(Code First)，3.  通过数据库可视化设计器设计数据库，同时生成实体类(Model First)。</p>
<h4 id="实体类型"><a href="#实体类型" class="headerlink" title="实体类型"></a>实体类型</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class MyContext : DbContext</span><br><span class="line">&#123;</span><br><span class="line">    public DbSet&lt;Blog&gt; Blogs &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    protected override void OnModelCreating(ModelBuilder modelBuilder)</span><br><span class="line">    &#123;</span><br><span class="line">        modelBuilder.Entity&lt;Blog&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Blog</span><br><span class="line">&#123;</span><br><span class="line">    public int BlogId &#123; get; set; &#125;</span><br><span class="line">    public string Url &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;Post&gt; Posts &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 从模型中排除的类型</span><br><span class="line">[NotMapped]</span><br><span class="line">public class BlogMetadata</span><br><span class="line">&#123;</span><br><span class="line">    public DateTime LoadedFromDatabase &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>按照约定，每个实体类型将设置为映射到与公开实体的 DbSet 属性同名的数据库表。 如果给定实体不存在 DbSet，则使用类名称。或使用注解 [ Table(“tableName”) ]</p>
<h4 id="实体属性"><a href="#实体属性" class="headerlink" title="实体属性"></a>实体属性</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class Blog</span><br><span class="line">&#123;</span><br><span class="line">    public int BlogId &#123; get; set; &#125;</span><br><span class="line">    public string Url &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;从模型中排除的属性</span><br><span class="line">    [NotMapped]</span><br><span class="line">    public DateTime LoadedFromDatabase &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>列注解：</p>
<ul>
<li>列名 [ Column(“blog_id”) ]</li>
<li>数据类型 [Column(TypeName = “varchar(200)”)]</li>
<li>校验  [ MaxLength(500) ] [ Required ]       </li>
</ul>
</blockquote>
<h4 id="键"><a href="#键" class="headerlink" title="键"></a>键</h4><p>主键<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protected override void OnModelCreating(ModelBuilder modelBuilder)</span><br><span class="line">&#123;</span><br><span class="line">    modelBuilder.Entity&lt;Blog&gt;()</span><br><span class="line">        .HasKey(b &#x3D;&gt; b.BlogId)</span><br><span class="line">        .HasName(&quot;PrimaryKey_BlogId&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>Alternative Key<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class MyContext : DbContext</span><br><span class="line">&#123;</span><br><span class="line">    public DbSet&lt;Blog&gt; Blogs &#123; get; set; &#125;</span><br><span class="line">    public DbSet&lt;Post&gt; Posts &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    protected override void OnModelCreating(ModelBuilder modelBuilder)</span><br><span class="line">    &#123;</span><br><span class="line">        modelBuilder.Entity&lt;Post&gt;()</span><br><span class="line">            .HasOne(p &#x3D;&gt; p.Blog)</span><br><span class="line">            .WithMany(b &#x3D;&gt; b.Posts)</span><br><span class="line">            .HasForeignKey(p &#x3D;&gt; p.BlogUrl)</span><br><span class="line">            .HasPrincipalKey(b &#x3D;&gt; b.Url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="策略维护-多对多关系"><a href="#策略维护-多对多关系" class="headerlink" title="策略维护 多对多关系"></a>策略维护 多对多关系</h4><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/ef/core/modeling/relationships#other-relationship-patterns">官网Doc</a><br></p>
<blockquote>
<p>目前尚不支持多对多关系，没有实体类来表示联接表。 但是，您可以通过包含联接表的实体类并映射两个不同的一对多关系，来表示多对多关系。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">class MyContext : DbContext</span><br><span class="line">&#123;</span><br><span class="line">    public DbSet&lt;Post&gt; Posts &#123; get; set; &#125;</span><br><span class="line">    public DbSet&lt;Tag&gt; Tags &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    protected override void OnModelCreating(ModelBuilder modelBuilder)</span><br><span class="line">    &#123;</span><br><span class="line">        modelBuilder.Entity&lt;PostTag&gt;()</span><br><span class="line">            .HasKey(t &#x3D;&gt; new &#123; t.PostId, t.TagId &#125;);</span><br><span class="line"></span><br><span class="line">        modelBuilder.Entity&lt;PostTag&gt;()</span><br><span class="line">            .HasOne(pt &#x3D;&gt; pt.Post)</span><br><span class="line">            .WithMany(p &#x3D;&gt; p.PostTags)</span><br><span class="line">            .HasForeignKey(pt &#x3D;&gt; pt.PostId);</span><br><span class="line"></span><br><span class="line">        modelBuilder.Entity&lt;PostTag&gt;()</span><br><span class="line">            .HasOne(pt &#x3D;&gt; pt.Tag)</span><br><span class="line">            .WithMany(t &#x3D;&gt; t.PostTags)</span><br><span class="line">            .HasForeignKey(pt &#x3D;&gt; pt.TagId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Post</span><br><span class="line">&#123;</span><br><span class="line">    public int PostId &#123; get; set; &#125;</span><br><span class="line">    public string Title &#123; get; set; &#125;</span><br><span class="line">    public string Content &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;PostTag&gt; PostTags &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Tag</span><br><span class="line">&#123;</span><br><span class="line">    public string TagId &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;PostTag&gt; PostTags &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class PostTag</span><br><span class="line">&#123;</span><br><span class="line">    public int PostId &#123; get; set; &#125;</span><br><span class="line">    public Post Post &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public string TagId &#123; get; set; &#125;</span><br><span class="line">    public Tag Tag &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 博客</span><br><span class="line">public class Blog</span><br><span class="line">&#123;</span><br><span class="line">    public int BlogId &#123; get; set; &#125;</span><br><span class="line">    public string Url &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;Post&gt; Posts &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 文章</span><br><span class="line">public class Post</span><br><span class="line">&#123;</span><br><span class="line">    public int PostId &#123; get; set; &#125;</span><br><span class="line">    public string Title &#123; get; set; &#125;</span><br><span class="line">    public string Content &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public int BlogId &#123; get; set; &#125;</span><br><span class="line">    public Blog Blog &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Post是依赖实体</li>
<li>Blog是主体实体</li>
<li>Blog.BlogId是主体键（在本例中为主密钥，而不是备用密钥）</li>
<li>Post.BlogId为外键</li>
<li>Post.Blog是一个引用导航属性</li>
<li>Blog.Posts是集合导航属性</li>
<li>Post.Blog是的反向导航属性 <h4 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class Blog</span><br><span class="line">&#123;</span><br><span class="line">    public int BlogId &#123; get; set; &#125;</span><br><span class="line">    public string Url &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public BlogImage BlogImage &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class BlogImage</span><br><span class="line">&#123;</span><br><span class="line">    public int BlogImageId &#123; get; set; &#125;</span><br><span class="line">    public byte[] Image &#123; get; set; &#125;</span><br><span class="line">    public string Caption &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    public int BlogId &#123; get; set; &#125;</span><br><span class="line">    public Blog Blog &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
配置关系时HasForeignKey必须指定实体类型，这一点区别于上面的书写方式<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">modelBuilder.Entity&lt;Blog&gt;()</span><br><span class="line">    .HasOne(b &#x3D;&gt; b.BlogImage)</span><br><span class="line">    .WithOne(i &#x3D;&gt; i.Blog)</span><br><span class="line">    .HasForeignKey&lt;BlogImage&gt;(b &#x3D;&gt; b.BlogForeignKey);</span><br></pre></td></tr></table></figure>
<h4 id="关联关系"><a href="#关联关系" class="headerlink" title="关联关系"></a>关联关系</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class MyContext : DbContext</span><br><span class="line">&#123;</span><br><span class="line">    public DbSet&lt;Blog&gt; Blogs &#123; get; set; &#125;</span><br><span class="line">    public DbSet&lt;Post&gt; Posts &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    protected override void OnModelCreating(ModelBuilder modelBuilder)</span><br><span class="line">    &#123;</span><br><span class="line">        modelBuilder.Entity&lt;Post&gt;()</span><br><span class="line">            .HasOne&lt;Blog&gt;()</span><br><span class="line">            .WithMany()</span><br><span class="line">            .HasForeignKey(p &#x3D;&gt; p.BlogId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">关联关系有Reqiuired和Optional之分，前者的情况下，对主体实体的删除会导致依赖实体被级联删除，而对于后者，默认不被配置为级联删除而将外键属性置为null</span><br></pre></td></tr></table></figure>
<h4 id="关联查询"><a href="#关联查询" class="headerlink" title="关联查询"></a>关联查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public async Task&lt;IActionResult&gt; Details(string code)</span><br><span class="line">&#123;</span><br><span class="line">    if (code &#x3D;&#x3D; null)</span><br><span class="line">    &#123;</span><br><span class="line">        return NotFound();</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; Blog &lt;&gt;--- ReferenceMap ---&lt;&gt; Theme</span><br><span class="line">    var Blog &#x3D; await _context. Blogs</span><br><span class="line">                    .Include(blog &#x3D;&gt; blog.ReferenceMap)</span><br><span class="line">                    .ThenInclude(map &#x3D;&gt; map.Theme)</span><br><span class="line">                    .FirstOrDefaultAsync(m &#x3D;&gt; m.Code &#x3D;&#x3D; code);</span><br><span class="line">    if (Blog &#x3D;&#x3D; null)</span><br><span class="line">    &#123;</span><br><span class="line">        return NotFound();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return View(Blog);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
Inclulde 被称为 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/ef/core/querying/related-data/eager">预先加载 eager load</a><br>使用ThenInclude关联多个层次<br>Include可以包含过滤, 如下取得曾发表带’敏感’词标题文章的所有博客，以及相应的文章<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var restrictBlogs &#x3D; _context.Blogs.Include(blog &#x3D;&gt; blog.Posts.Where(post &#x3D;&gt; post.Title.Contains(&quot;敏感&quot;))).ToList()</span><br></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<p>显式加载(explicit load)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var blog &#x3D; _context.Blogs.Single(blog&#x3D;&gt;blog.Author&#x3D;&#x3D;&quot;QQs&quot;) &#x2F;&#x2F; 此处关联属性Posts为null</span><br><span class="line">...</span><br><span class="line">var posts &#x3D; _context.Entry(blog).Collection(blog &#x3D;&gt; blog.Posts).Query().Where(post &#x3D;&gt; post.Title.Contains(&quot;敏感&quot;)).ToList() &#x2F;&#x2F; 此时blog对象的Posts属性被填充（仅过滤结果）</span><br></pre></td></tr></table></figure><br>不返回结果posts可以直接Load<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_context.Entry(blog).Collection(blog &#x3D;&gt; blog.Posts).Load()</span><br></pre></td></tr></table></figure><br>QQs：私以为这与预先加载并无多大区别</p>
<p>延迟加载（lazy load）<br>见<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/ef/core/querying/related-data/lazy">Microsoft Docs：相关数据的延迟加载</a></p>
<h4 id="关联存储"><a href="#关联存储" class="headerlink" title="关联存储"></a>关联存储</h4><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/ef/core/saving/related-data">here</a><br>向导航属性（blog.Posts）中添加新实体，EF自动发现关联实体并将其插入数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">await using (var context &#x3D; new BloggingContext())</span><br><span class="line">&#123;</span><br><span class="line">    var blog &#x3D; await context.Blogs.Include(b &#x3D;&gt; b.Posts).FirstAsync();</span><br><span class="line">    var post &#x3D; new Post &#123; Title &#x3D; &quot;Intro to EF Core&quot; &#125;;</span><br><span class="line"></span><br><span class="line">    blog.Posts.Add(post);</span><br><span class="line">    await context.SaveChangesAsync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>自动更改外键列<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">await using (var context &#x3D; new BloggingContext())</span><br><span class="line">&#123;</span><br><span class="line">    var blog &#x3D; new Blog &#123; Url &#x3D; &quot;http:&#x2F;&#x2F;blogs.msdn.com&#x2F;visualstudio&quot; &#125;;</span><br><span class="line">    var post &#x3D; await context.Posts.FirstAsync();</span><br><span class="line"></span><br><span class="line">    post.Blog &#x3D; blog;</span><br><span class="line">    await context.SaveChangesAsync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>上面的代码没有显式操作外键post.blogId，但EF会自动更新，并且将所需的新实体blog插入数据库</p>
<h4 id="CRUD"><a href="#CRUD" class="headerlink" title="CRUD"></a>CRUD</h4><p>使用数据库上下文修改模型(包括新增和移除)，并执行SaveChanges，相当于commit<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; create</span><br><span class="line">context.Add(new Student&#123;</span><br><span class="line">    FirstName&#x3D;&quot;Jack&quot;,</span><br><span class="line">    SurName&#x3D;&quot;Ma&quot;</span><br><span class="line">&#125;);</span><br><span class="line">context.SaveChanges();</span><br><span class="line">&#x2F;&#x2F; select</span><br><span class="line">var MaYun &#x3D; context.Students</span><br><span class="line">            .Where(s &#x3D;&gt; s.FirstName &#x3D;&#x3D; GetName()).ToList();</span><br><span class="line">&#x2F;&#x2F; update</span><br><span class="line">MaYun.Age&#x3D;8;</span><br><span class="line">context.Update(MaYun)</span><br><span class="line">context.SaveChanges()</span><br><span class="line">&#x2F;&#x2F; delete</span><br><span class="line">context.Remove(MaYun);</span><br><span class="line">context.SaveChanges()</span><br></pre></td></tr></table></figure><br>一般在web应用中使用异步<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; create</span><br><span class="line">context.Add(new Student&#123;</span><br><span class="line">    FirstName&#x3D;&quot;Jack&quot;,</span><br><span class="line">    SurName&#x3D;&quot;Ma&quot;</span><br><span class="line">&#125;);</span><br><span class="line">context.SaveChangesAsync();</span><br><span class="line">&#x2F;&#x2F; select</span><br><span class="line">var MaYun &#x3D; context.Students</span><br><span class="line">            .Where(s &#x3D;&gt; s.FirstName &#x3D;&#x3D; GetName()).ToListAsync();</span><br><span class="line">&#x2F;&#x2F; update</span><br><span class="line">MaYun.Age&#x3D;8;</span><br><span class="line">context.SaveChangesAsync()</span><br><span class="line">&#x2F;&#x2F; delete</span><br><span class="line">context.Remove(MaYun);</span><br><span class="line">context.SaveChangesAsync()</span><br></pre></td></tr></table></figure><br><span style="color:#f50;font-weight:bold">Caution!</span> 在对DbContext的多次操作中，如果前面一次SaveChanges出错，如Add操作违反唯一约束而失败，需要将该实体类实例从DbContext中移除(或修正)，否则出错的命令会一直在提交队列中，反复报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">try</span><br><span class="line">&#123;</span><br><span class="line">    _context.Add(newBlog);</span><br><span class="line">    await _context.SaveChangesAsync();</span><br><span class="line">&#125;</span><br><span class="line">catch (Microsoft.EntityFrameworkCore.DbUpdateException dbEx)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; TODO the result description is not properly rigorous.</span><br><span class="line">    if (null !&#x3D; dbEx.InnerException</span><br><span class="line">        &amp;&amp; dbEx.InnerException.Message.Contains(&quot;constraint&quot;))</span><br><span class="line">    &#123;</span><br><span class="line">        System.Console.WriteLine(&quot;Blog exists;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; other error handle</span><br><span class="line">    &#125;</span><br><span class="line">    _context.Remove(newBlog);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>DBContext.Add成功后 若主键id使用数据库策略生成 Add成功后即可从对象中取到</p>
<h4 id="DBcontext和connectionstring"><a href="#DBcontext和connectionstring" class="headerlink" title="DBcontext和connectionstring"></a>DBcontext和connectionstring</h4><p>startup.cs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void ConfigureServices(IServiceCollection services)</span><br><span class="line">&#123;</span><br><span class="line">    services.AddDbContext&lt;BloggingContext&gt;(options &#x3D;&gt;</span><br><span class="line">        options.UseSqlServer(Configuration.GetConnectionString(&quot;DBConnection&quot;)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="重连"><a href="#重连" class="headerlink" title="重连"></a>重连</h4><p>数据库如SQL Server的provider程序，可以识别可重试（retry）的异常类型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public void ConfigureServices(IServiceCollection services)</span><br><span class="line">&#123;</span><br><span class="line">    services.AddDbContext&lt;PicnicContext&gt;(</span><br><span class="line">        options &#x3D;&gt; options.UseSqlServer(</span><br><span class="line">            Configuration.GetConnectionString(&quot;DBConnection&quot;),</span><br><span class="line">            providerOptions &#x3D;&gt; providerOptions.EnableRetryOnFailure()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h4><p>额外的，<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/connection-resiliency">Transaction commit failure</a></p>
<p>对于多项实体操作(CRUD)后SaveChanges，SaveChanges是事务性的，意味着前面所有操作成功或失败，而不会产生部分成功部分失败</p>
<h4 id="Lazy-load"><a href="#Lazy-load" class="headerlink" title="Lazy load"></a>Lazy load</h4><p>访问导航属性（外键）时再次查询数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">using (var dbContext &#x3D; new CategoryEntities())</span><br><span class="line">&#123;</span><br><span class="line">    dbContext.Configuration.LazyLoadingEnabled &#x3D; true; &#x2F;&#x2F; 默认是true，针对导航属性</span><br><span class="line">        var categoryList &#x3D; dbContext.Set&lt;Category&gt;().Where(p &#x3D;&gt; p.CategoryId &#x3D;&#x3D; 3);</span><br><span class="line">        &#x2F;&#x2F; 只会在数据库里面查询Category表，不会查询ProductDetail表</span><br><span class="line">        foreach(var category in categoryList)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(&quot;CategoryId:&quot;+category.CategoryId+ &quot;,CategoryName:&quot;+category.CategoryName);</span><br><span class="line">            &#x2F;&#x2F; 这时才会去数据库查询ProductDetail表</span><br><span class="line">            foreach (var product in category.ProductDetails)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(&quot;ProductName:&quot;+product.ProductName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>不再继续查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">using (var dbContext &#x3D; new CategoryEntities())</span><br><span class="line">&#123;</span><br><span class="line">    dbContext.Configuration.LazyLoadingEnabled &#x3D; false; &#x2F;&#x2F; 不延迟加载,不会再次查询了</span><br><span class="line">    var categoryList &#x3D; dbContext.Set&lt;Category&gt;().Where(p &#x3D;&gt; p.CategoryId &#x3D;&#x3D; 3);</span><br><span class="line">    &#x2F;&#x2F; 只会在数据库里面查询Category表，不会查询ProductDetail表</span><br><span class="line">    foreach (var category in categoryList)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(&quot;CategoryId:&quot; + category.CategoryId + &quot;,CategoryName:&quot; + category.CategoryName);</span><br><span class="line">        &#x2F;&#x2F; 这时不会去数据库查询了，所以用户全是空的</span><br><span class="line">        foreach (var product in category.ProductDetails)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(&quot;ProductName:&quot; + product.ProductName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>一次性完成查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 显示加载</span><br><span class="line">using (var dbContext &#x3D; new CategoryEntities())</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; 不延迟加载，指定Include，一次性加载主表和从表的所有数据</span><br><span class="line">    var categoryList &#x3D; dbContext.Set&lt;Category&gt;().Include(&quot;ProductDetails&quot;).Where(p &#x3D;&gt; p.CategoryId &#x3D;&#x3D; 3);</span><br><span class="line">    foreach (var category in categoryList)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(&quot;CategoryId:&quot; + category.CategoryId + &quot;,CategoryName:&quot; + category.CategoryName);</span><br><span class="line">        &#x2F;&#x2F; 不会再查询</span><br><span class="line">        foreach (var product in category.ProductDetails)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(&quot;ProductName:&quot; + product.ProductName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>issue: Data is Null. This method or property cannot be called on Null values.</p>
<p>一个很简单的出错原因是model的基本类型（非对象，不能设置为null）如int，Guid等的属性，其对应的table field为null。<br>应以int?,Guid?作为属性类型以支持null</p>
<h4 id="Parent-Child"><a href="#Parent-Child" class="headerlink" title="Parent/Child"></a>Parent/Child</h4><p>对应于使用id，parentid组织的父子关系表，常见的组织机构树，职能头衔树等<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class Group</span><br><span class="line">&#123;</span><br><span class="line">    public Guid ID &#123; get; set; &#125;</span><br><span class="line">    public string Name &#123; get; set; &#125;</span><br><span class="line">    public Guid? ParentID &#123; get; set; &#125;</span><br><span class="line">    public Group Parent &#123; get; set; &#125;</span><br><span class="line">    </span><br><span class="line">    public ICollection&lt;Group&gt; Children &#123; get; &#125; &#x3D; new List&lt;Group&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>查询子树<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var data &#x3D; (await _context.Group.ToListAsync())</span><br><span class="line">            .Where(g &#x3D;&gt; g.ID &#x3D;&#x3D; new Guid(groupId))</span><br><span class="line">            .ToList();</span><br></pre></td></tr></table></figure></p>
<h4 id="Hierarchy-Data"><a href="#Hierarchy-Data" class="headerlink" title="Hierarchy Data"></a>Hierarchy Data</h4><p>参考<a target="_blank" rel="noopener" href="https://www.meziantou.net/using-hierarchyid-with-entity-framework-core.htm">Using SQL Server HierarchyId with Entity Framework Core</a><br>package: </p>
<ul>
<li>Microsoft.EntityFrameworkCore.SqlServer</li>
<li>EntityFrameworkCore.SqlServer.HierarchyId<br>数据库上下文需要配置启用HierarchyId，否则出现下述异常<br>The property is of type ‘HierarchyId’ which is not supported by current database provider. Either change the property CLR type or ignore the property using the ‘[NotMapped]’ attribute or by using ‘EntityTypeBuilder.Ignore’ in ‘OnModelCreating’.</li>
</ul>
</blockquote>
<p>在Startup.cs,配置启用HierarchyId<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> public void ConfigureServices(IServiceCollection services)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    services.AddDbContext&lt;DataContext&gt;(options &#x3D;&gt;</span><br><span class="line">        options.UseSqlServer(Configuration.GetConnectionString(&quot;DataContext&quot;), conf&#x3D;&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                conf.UseHierarchyId();</span><br><span class="line">            &#125;</span><br><span class="line">        ));</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>model定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class Group</span><br><span class="line">&#123;</span><br><span class="line">    public Guid ID &#123; get; set; &#125;</span><br><span class="line">    public string Name &#123; get; set; &#125;</span><br><span class="line">    public HierarchyId GroupLevel &#123; get; set; &#125;</span><br><span class="line">    </span><br><span class="line">    public ICollection&lt;Group&gt; Children &#123; get; &#125; &#x3D; new List&lt;Group&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>查询linq<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public async Task&lt;List&lt;Group&gt;&gt; GetChildrenByGroupIDAsync(Guid groupID)</span><br><span class="line">&#123;</span><br><span class="line">    Group self &#x3D; await _context.Groups.FindAsync(groupID);</span><br><span class="line">    List&lt;Group&gt; groups &#x3D; await _context.Groups</span><br><span class="line">        .Where(g &#x3D;&gt; g.GroupLevel.IsDescendantOf(self.GroupLevel))</span><br><span class="line">        .ToListAsync();</span><br><span class="line"></span><br><span class="line">    return groups; &#x2F;&#x2F;.FindAll(g &#x3D;&gt; g.ID !&#x3D; groupID);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>其他查询见文章<a href="/qqsnote/2020/06/15/sqlserver/" title="SQLServer">SQLServer</a></p>
<h4 id="Transient-Error"><a href="#Transient-Error" class="headerlink" title="Transient Error"></a>Transient Error</h4><blockquote>
<p>Exception: An exception has been raised that is likely due to a transient failure. Consider enabling transient error resiliency by adding ‘EnableRetryOnFailure()’ to the ‘UseSqlServer’ call.</p>
</blockquote>
<p>见<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/54186894/getting-transient-errors-when-making-calls-against-azure-sql-database-from-azure">StackOverflow: Getting transient errors when making calls against Azure SQL Database from Azure Function</a></p>
<p>数据库系统偶现Transient Error，这种暂时性错误的根本原因（underlying cause）很快就能自行解决，且在错误抛出时，.net程序会抛出上述的SqlException，为了处理这些错误，可应用程序代码中实现重试逻辑，而不是以应用程序错误的形式呈现给用户。<br>在Startup.cs,配置启用RetryOnFailure<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> public void ConfigureServices(IServiceCollection services)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    services.AddDbContext&lt;DataContext&gt;(options &#x3D;&gt;</span><br><span class="line">        options.UseSqlServer(Configuration.GetConnectionString(&quot;DataContext&quot;), conf&#x3D;&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                conf.EnableRetryOnFailure();</span><br><span class="line">            &#125;</span><br><span class="line">        ));</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><del>但是这里有个bug <a target="_blank" rel="noopener" href="https://github.com/efcore/EFCore.SqlServer.HierarchyId/issues/24">System.ArgumentException thrown when EnableRetryOnFailure is used.</a></del> 该bug已在dotNet 5版本修复</p>
<h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;customers&gt; _customers &#x3D; (from a in db.customers select a).ToList();</span><br><span class="line">var _dataToWebPage &#x3D; _customers.Skip(50).Take(50);</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/10145815/c-sharp-entity-framework-pagination">StackOverflow:C# entity framework pagination</a></p>
<h4 id="ORM注意事项"><a href="#ORM注意事项" class="headerlink" title="ORM注意事项"></a>ORM注意事项</h4><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/ef/core/#ef-orm-considerations">EF O/RM 注意事项</a></p>
<h4 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h4><p>startup.cs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">services.AddDbContext&lt;MyDBContext&gt;(options &#x3D;&gt; &#123;</span><br><span class="line">    options.UseSqlServer(Configuration.GetConnectionString(&quot;MyDBContext&quot;), conf &#x3D;&gt; &#123;</span><br><span class="line">        conf.UseHierarchyId();</span><br><span class="line">        conf.EnableRetryOnFailure();</span><br><span class="line">    &#125;);</span><br><span class="line">    options.LogTo(System.Console.WriteLine);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/ef/core/logging-events-diagnostics/simple-logging">Docs:简单的日志记录</a><br>日志委托和日志级别：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options.LogTo(Console.WriteLine, LogLevel.Information;</span><br></pre></td></tr></table></figure></p>
<h4 id="Exception：this-sqltransaction-has-completed-it-is-no-longer-usable"><a href="#Exception：this-sqltransaction-has-completed-it-is-no-longer-usable" class="headerlink" title="Exception：this sqltransaction has completed it is no longer usable"></a>Exception：this sqltransaction has completed it is no longer usable</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[HttpPost]</span><br><span class="line">[Route(&quot;api&#x2F;[controller]&#x2F;create&quot;)]</span><br><span class="line">public async Task&lt;Result&gt; Create([FromBody] QModel model)&#123;</span><br><span class="line">    ...</span><br><span class="line">    try&#123;</span><br><span class="line">        _context.Add(model);</span><br><span class="line">        await _context.SaveChangesAsync();</span><br><span class="line">    &#125;catch(Exception ex)&#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上一个insert数据的接口，在有限的并发条件下（也就是for循环几条请求），个别错误数据可以造成其他正常数据插入失败<br>报 this sqltransaction has completed it is no longer usable 以及 zombie check等解释<br>查了2天资料未能解决<br>次日反思 问题或许出在多条线程同时向数据库上下文中推数据（即_context.Add）其中一个错误数据的出错，事务自动回滚，导致了其他线程中访问该事务已不可用。<br>此处使用_context.AddAsync方法可以解决<br>即，该问题就是个ef方法的线程安全的问题，可见<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/47135262/addasync-vs-add-in-ef-core">StackOverflow: AddAsync vs Add</a><br>那么我一个需求要添加user并为其分配新的group，一个事务里两个add操作怎么办呢，另起一小节：</p>
<h4 id="一个事务多个操作的线程安全"><a href="#一个事务多个操作的线程安全" class="headerlink" title="一个事务多个操作的线程安全"></a>一个事务多个操作的线程安全</h4><p>其实在官方文档最初的概述中，强调了DbContext的线程不安全 见<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/ef/core/dbcontext-configuration/#the-dbcontext-lifetime">Microsoft Docs: DBContext Lifetime</a></p>
<blockquote>
<p>DbContext 不是线程安全的。 不要在线程之间共享上下文。 请确保在继续使用上下文实例之前，等待所有异步调用。</p>
</blockquote>
<p>关于以事务作为上下文生命周期的配置, 见<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/41923804/configuring-dbcontext-as-transient">StackOverflow:Configuring Dbcontext as Transient</a> <span style="color:#f00;font-weight:bold">然而!</span>经实践同一接口的并发测试 仍然会出现this sqltransaction has completed it is no longer usable的异常<br>依赖注入的DBContext<br>在Startup的ConfigureServices中注册MyDBContext服务提供程序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">services.AddDbContext&lt;MyDBContext&gt;(</span><br><span class="line">    options &#x3D;&gt; options.UseSqlServer(Configuration.GetConnectionString(&quot;MyDBContext&quot;),</span><br><span class="line">                                conf &#x3D;&gt; &#123; conf.UseHierarchyId();</span><br><span class="line">                                    conf.EnableRetryOnFailure();</span><br><span class="line">                                &#125;), ServiceLifetime.Transient);</span><br></pre></td></tr></table></figure><br>注入DBContext:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class GroupsController : ControllerBase</span><br><span class="line">&#123;</span><br><span class="line">    private readonly MyDBContext _context;</span><br><span class="line">    private IGroupTreeService _groupTreeService;</span><br><span class="line"></span><br><span class="line">    public GroupsController(MyDBContext context, IGroupTreeService groupTreeService)</span><br><span class="line">    &#123;</span><br><span class="line">        _context &#x3D; context;</span><br><span class="line">        _groupTreeService &#x3D; groupTreeService;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>控制DBContext生命周期在函数内部<br>官方Doc：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/ef/core/miscellaneous/connection-resiliency#execution-strategies-and-transactions">启用RetryOnFailue情形下的手动事务方式</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public interface IWorker</span><br><span class="line">&#123;</span><br><span class="line">    void DoWork(Func&lt;MyDbContext&gt; dbFactory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class WorkerRunner</span><br><span class="line">&#123;</span><br><span class="line">    private readonly DbContextOptions&lt;MyDbContext&gt; _dbOptions;</span><br><span class="line"></span><br><span class="line">    private readonly List&lt;IWorker&gt; _workers;</span><br><span class="line"></span><br><span class="line">    public WorkerRunner(DbContextOptions&lt;MyDbContext&gt; dbOptions, List&lt;IWorker&gt; workers)</span><br><span class="line">    &#123;</span><br><span class="line">        _dbOptions &#x3D; dbOptions;</span><br><span class="line">        _workers &#x3D; workers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void RunWorkers()</span><br><span class="line">    &#123;</span><br><span class="line">        using (var context &#x3D; new MyDbContext(_dbOptions))</span><br><span class="line">        &#123;</span><br><span class="line">            using (var tran &#x3D; context.Database.BeginTransaction())</span><br><span class="line">            &#123;</span><br><span class="line">                foreach (var worker in _workers)</span><br><span class="line">                    worker.DoWork(() &#x3D;&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        &#x2F;&#x2F; This won&#39;t work</span><br><span class="line">                        var db &#x3D; new MyDbContext(_dbOptions);</span><br><span class="line">                        &#x2F;&#x2F; And this one will even throw exception when used with in-memory database (during unit testing)</span><br><span class="line">                        db.Database.UseTransaction(tran.GetDbTransaction());</span><br><span class="line">                        return context;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">                tran.Commit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>就是new一个DBContext用， <span style="color:#ff0;font-weight:bold">Caution!</span> 经测单靠new DBContext不能阻止transaction Error</p>
<h4 id="自动生成id"><a href="#自动生成id" class="headerlink" title="自动生成id"></a>自动生成id</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Table(&quot;User&quot;)]</span><br><span class="line">public class User&#123;</span><br><span class="line">    [Key]</span><br><span class="line">    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]</span><br><span class="line">    public string Id &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protected override void OnModelCreating(ModelBuilder modelBuilder)</span><br><span class="line">&#123;</span><br><span class="line">    modelBuilder.Entity&lt;User&gt;()</span><br><span class="line">        .Property(e &#x3D;&gt; e.Role)</span><br><span class="line">        .HasDefaultValue(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qqstone.github.io/qqsnote/2020/06/15/sqlserver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/qqsnote/images/avatar.gif">
      <meta itemprop="name" content="QQs">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QQs'Note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/qqsnote/2020/06/15/sqlserver/" class="post-title-link" itemprop="url">SQL Server</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-15 14:19:55" itemprop="dateCreated datePublished" datetime="2020-06-15T14:19:55+08:00">2020-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-07-05 10:07:52" itemprop="dateModified" datetime="2025-07-05T10:07:52+08:00">2025-07-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/qqsnote/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlcmd -S .\SqlExpress</span><br><span class="line">NET START&#x2F;PAUSE&#x2F;CONTINUE&#x2F;STOP&#x2F; MSSQLSERVER</span><br></pre></td></tr></table></figure>
<p>QQs未能成功实践。。<br>或者，任务管理器手动启动 MSSQL$SQLEXPRESS </p>
<h4 id="schema"><a href="#schema" class="headerlink" title="schema"></a>schema</h4><p>在MySQL中schema的概念和database一致<br><br>但是微软搞什么都要多加点概念，sqlserver中，表名前带有schema标记如dbo.table1,这里的dbo指数据库的默认用户database owner<br><br>导出表结构（create table）语句时会带着schema<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">create table [ent].[tabletemp](</span><br><span class="line">	[Id] [uniqueidentifier] NOT NULL,</span><br><span class="line">	[Name] [nvarchar](50) NULL,</span><br><span class="line">PRIMARY KEY CLUSTERED </span><br><span class="line">(</span><br><span class="line">	[Id] ASC</span><br><span class="line">)WITH (PAD_INDEX &#x3D; OFF, STATISTICS_NORECOMPUTE &#x3D; OFF, IGNORE_DUP_KEY &#x3D; OFF, ALLOW_ROW_LOCKS &#x3D; ON, ALLOW_PAGE_LOCKS &#x3D; ON) ON [PRIMARY]</span><br><span class="line">) ON [PRIMARY]</span><br></pre></td></tr></table></figure><br>迁移时执行该语句会提示”The specified schema name “env” either does not exist or you do not have permission to use it.”<br><br>创建schema<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create schema ent</span><br></pre></td></tr></table></figure><br>变更schema<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER SCHEMA ent TRANSFER OBJECT::dbo.table1;  </span><br></pre></td></tr></table></figure></p>
<h4 id="创建新用户及授权访问"><a href="#创建新用户及授权访问" class="headerlink" title="创建新用户及授权访问"></a>创建新用户及授权访问</h4><p><a target="_blank" rel="noopener" href="https://www.fujieace.com/mssql/create-login.html">参考原文</a><br></p>
<ul>
<li>配置登录名 Database Server —&gt; Security —&gt; Logins —&gt; 右键New Login</li>
<li>常规General标签页中，配置认证方式等</li>
<li>服务器角色（Server Roles）添加 public sysadmon</li>
<li>用户映射（User Mapping）添加创建的新用户</li>
<li>安全对象（Securable）搜索 —&gt; 选择 The Server(当前数据库服务器名)</li>
<li>状态默认</li>
</ul>
<h4 id="ServerName"><a href="#ServerName" class="headerlink" title="ServerName"></a>ServerName</h4><p>sqlserver实例默认以计算机名+服务提供者命名，如SHAL400/SQLEXPRESS, 甚至用ip代替计算机名都会导致无法连接.<br><br>配置sqlserver支持远程访问:<br></p>
<ol>
<li>从本地SSMS连接数据库，右键服务器—Facets—Server Configuration—RemoteAccessEnable=true<br><img src="https://tva1.sinaimg.cn/large/a60edd42gy1gij7y2m0oxj20u40qm75y.jpg" alt="sqlserver_remote_access"></li>
<li>打开SQL Server Configuration Manager(SSCM) SQL Server Browser Running, </li>
<li>SSCM—SQL Server Network Configuration—Protocols for SQLEXPRESS—TCP/IP Enable, 然后右键打开Properties设置ip及端口如下（注意IPAll的TCP Dynamic Ports不要写死）<br> <img src="https://i0.wp.com/tvax3.sinaimg.cn/large/a60edd42gy1gij89zv9myj20ef0hk75n.jpg" alt="sqlserver_remote_access_tcpip"></li>
<li>配置防火墙略<br></li>
</ol>
<h4 id="调用存储过程"><a href="#调用存储过程" class="headerlink" title="调用存储过程"></a>调用存储过程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXEC storedProcedure1 @param&#x3D;&#39;01&#39;</span><br></pre></td></tr></table></figure>
<h4 id="约束Constraint"><a href="#约束Constraint" class="headerlink" title="约束Constraint"></a>约束Constraint</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE [dbo].[Group](</span><br><span class="line">	[ID] [uniqueidentifier] NOT NULL,</span><br><span class="line">	[CreateTime] [datetime2](7) NULL,</span><br><span class="line">	[Name] [nvarchar](80) NULL,</span><br><span class="line">	[Valid] [bit] NOT NULL,</span><br><span class="line">	[UpdateTime] [datetime2](7) NULL,</span><br><span class="line">	[Comment] [nvarchar](500) NULL,</span><br><span class="line">    CONSTRAINT [AK_Group_Name] UNIQUE ([Name])</span><br><span class="line">) ON [PRIMARY]</span><br></pre></td></tr></table></figure>
<h4 id="关于大小写"><a href="#关于大小写" class="headerlink" title="关于大小写"></a>关于大小写</h4><p>据说sqlserver 安装过程中有是否区分大小写的选项，默认情况下无论表名、列名、字段、参数都不区分大小写，更过分的是查询条件的值也不区分————where name=’abc’和where name=’AbC’是一样的结果。如果要区分查询条件的大小写，中文网络上建议如下例子，追加条件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from table1 where name&#x3D;&#39;abc&#39; collate Chinese_PRC_CS_AI_WS </span><br></pre></td></tr></table></figure><br>Chinese_PRC_CS_AI_WS实际表示中国大陆UNICODE字符集规则（Chinese PRC），区分大小写（Case Sensitive，CS），不区分重音（Accent Insensitive，AI），区分宽度（Width Sensitive，WS，半角/全角字符受此条件影响）<br><br>类似的还有<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SQL_Latin1_General_CP1_CS_AI</span><br><span class="line">Latin1_General_CS_AI</span><br></pre></td></tr></table></figure><br>查询当前默认规则<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT SERVERPROPERTY(N&#39;Collation&#39;)</span><br></pre></td></tr></table></figure><br>查询支持的字符集规则<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * from ::fn_helpcollations()</span><br></pre></td></tr></table></figure></p>
<h4 id="内置对象的表"><a href="#内置对象的表" class="headerlink" title="内置对象的表"></a>内置对象的表</h4><ul>
<li><p>sys.schemas</p>
</li>
<li><p>执行历史</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SELECT TOP 1000 QS.creation_time, </span><br><span class="line">SUBSTRING(ST.text, </span><br><span class="line">		(QS.statement_start_offset &#x2F; 2) + 1, </span><br><span class="line">		((CASE QS.statement_end_offset </span><br><span class="line">			WHEN - 1 THEN DATALENGTH(st.text) </span><br><span class="line">			ELSE QS.statement_end_offset </span><br><span class="line">			END - QS.statement_start_offset) &#x2F; 2) + 1)</span><br><span class="line">			AS statement_text, </span><br><span class="line">		ST.text, </span><br><span class="line">		QS.total_worker_time, </span><br><span class="line">		QS.last_worker_time, </span><br><span class="line">		QS.max_worker_time, </span><br><span class="line">		QS.min_worker_time</span><br><span class="line">FROM        </span><br><span class="line">sys.dm_exec_query_stats QS CROSS APPLY sys.dm_exec_sql_text(QS.sql_handle) ST</span><br><span class="line">WHERE   1&#x3D;1 </span><br></pre></td></tr></table></figure>
<h4 id="edit-data"><a href="#edit-data" class="headerlink" title="edit data"></a>edit data</h4><p>SSIS提供了Edit Top 200 Rows,但是写入表格内容各种格式不正确，宜Script Table to…Insert to<br><br>Guid用NEWID(),时间就用SYSDATETIME()</p>
<h4 id="STUFF"><a href="#STUFF" class="headerlink" title="STUFF"></a>STUFF</h4></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STUFF ( character_expression , start , length , character_expression )</span><br></pre></td></tr></table></figure>
<h4 id="CAST-amp-CONVERT"><a href="#CAST-amp-CONVERT" class="headerlink" title="CAST &amp; CONVERT"></a>CAST &amp; CONVERT</h4><p>数据类型转换<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT CAST(t1.num AS varchar) from t1;</span><br><span class="line">SELECT CONVERT(varchar, t1.num) from t1;</span><br></pre></td></tr></table></figure></p>
<h4 id="将自然键替换为人工键"><a href="#将自然键替换为人工键" class="headerlink" title="将自然键替换为人工键"></a>将自然键替换为人工键</h4><p>原实体以序列号为主键，现添加ID列并填充GUID<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE dbo.Table1 DROP CONSTRAINT PK_Table1 &#x2F;&#x2F; 移除原主键</span><br><span class="line">ALTER TABLE dbo.Table1 DROP COLUMN SerialNumber &#x2F;&#x2F; 移除列</span><br><span class="line">ALTER TABLE dbo.Table1 ADD ID uniqueidentifier NOT NULL default newID()</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>exception The object ‘DF<strong>Table1</strong>ID__34C8D9D1’ is dependent on column ‘ID’. ALTER TABLE DROP COLUMN failed because one or more objects access this column</p>
</blockquote>
<p>ID作为列名会默认添加CONSTRAINT，如上所提及的DF<strong>Table1</strong>ID<strong>34C8D9D1 因此要删除这个ID列需要先 ALTER TABLE dbo.Table1 DROP CONSTRAINT DF</strong>Table1<strong>ID</strong>34C8D9D1</p>
<h4 id="层次结构数据"><a href="#层次结构数据" class="headerlink" title="层次结构数据"></a>层次结构数据</h4><p>具有父级、子级关系的层次结构数据<br>Oracle的递归查询语法:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select  * from t_dw CONNECT BY PRIOR id &#x3D; parentID START WITH id&#x3D;&#39;dw001&#39;</span><br></pre></td></tr></table></figure><br>SqlServer中没有上述语法，而使用内置hierarchyid简化层次结构数据的存储和查询，</p>
<p><a target="_blank" rel="noopener" href="https://www.meziantou.net/using-hierarchyid-with-entity-framework-core.htm">https://www.meziantou.net/using-hierarchyid-with-entity-framework-core.htm</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-- 根节点 &#x2F;</span><br><span class="line">update t_dw set orgLvl&#x3D;HierarchyID::GetRoot() where parentID is null</span><br><span class="line">-- 子树   &#x2F;1&#x2F;,&#x2F;2&#x2F;</span><br><span class="line">update t_dw set orgLvl&#x3D;HierarchyID::Parse(&#39;&#x2F;1&#x2F;&#39;) where name&#x3D;&#39;dw1&#39;</span><br><span class="line">update t_dw set orgLvl&#x3D;HierarchyID::Parse(&#39;&#x2F;2&#x2F;&#39;) where name&#x3D;&#39;dw2&#39;</span><br><span class="line">-- 叶    &#x2F;1&#x2F;3&#x2F;</span><br><span class="line">update t_dw set orgLvl&#x3D;HierarchyID::Parse(&#39;&#x2F;1&#x2F;1&#x2F;&#39;) where name&#x3D;&#39;dw1-a&#39;</span><br></pre></td></tr></table></figure>
<p>插入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert t_dw (id,name,ParentID,orgLvl) </span><br><span class="line">values(newid(),&#39;dw1-b&#39;,&#39;xxxxxxxxxxxxxxx&#39;,</span><br><span class="line">HierarchyID::Parse(&#39;&#x2F;1&#x2F;&#39;).GetDescendant(CAST(&#39;&#x2F;1&#x2F;1&#x2F;&#39; AS hierarchyid), NULL))</span><br></pre></td></tr></table></figure><br>得到/1/2/ dw1-b 即在/1/的子节点，左树为/1/1/右树为null位置插入新节点</p>
<p>层级<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT CAST(&#39;&#x2F;1&#x2F;2&#x2F;&#39; AS hierarchyid).GetLevel() -- 结果：2</span><br></pre></td></tr></table></figure><br>后代<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT name, orgLvl.ToString()</span><br><span class="line">FROM t_dw</span><br><span class="line">WHERE orgLvl.IsDescendantOf(CAST(&#39;&#x2F;1&#x2F;&#39; AS hierarchyid)) &#x3D; 1</span><br></pre></td></tr></table></figure><br>IsDescendant为1(表示true)返回所有后代(实际上也包括‘/1/’自己), 0返回所有非后代（父代，sibling树）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT name, orgLvl.ToString()</span><br><span class="line">FROM t_dw</span><br><span class="line">WHERE orgLvl.GetAncestor(2) &#x3D; HierarchyID::Parse(&#39;&#x2F;1&#x2F;&#39;)</span><br></pre></td></tr></table></figure><br>GetAncestor返回指定层级的后代，参数为层级：0返回‘/1/’自己；1返回所有子节点，2返回所有孙子节点</p>
<p>移动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DECLARE @CurrentNode hierarchyid , @OldParent hierarchyid, @NewParent hierarchyid </span><br><span class="line">select  @CurrentNode&#x3D;orgLvl from t_dw where name&#x3D;&#39;dw_x&#39;; -- &#x2F;1&#x2F;1&#x2F;</span><br><span class="line">select  @OldParent&#x3D;orgLvl from t_dw where name&#x3D;&#39;dw_old&#39;; -- &#x2F;1&#x2F;</span><br><span class="line">select  @NewParent&#x3D;orgLvl from t_dw where name&#x3D;&#39;dw_new&#39;; -- &#x2F;3&#x2F;</span><br><span class="line">UPDATE t_dw  </span><br><span class="line">SET OrgNode &#x3D; @CurrentNode.GetReparentedValue(@OldParent, @NewParent)   </span><br><span class="line">WHERE OrgNode &#x3D; @CurrentNode ; -- &#x2F;3&#x2F;1&#x2F; </span><br><span class="line">GO  </span><br></pre></td></tr></table></figure><br>其他进阶操作：<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/sql/relational-databases/hierarchical-data-sql-server?view=sql-server-ver15#finding-ancestors-by-using-the-clr">查找祖先</a><br><a href="[列出祖先](https://docs.microsoft.com/zh-cn/sql/relational-databases/hierarchical-data-sql-server?view=sql-server-ver15#listing-ancestors">列出祖先</a>)<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/sql/relational-databases/hierarchical-data-sql-server?view=sql-server-ver15#moving-subtrees">移动子树</a></p>
<h4 id="获取每个表的数据条数"><a href="#获取每个表的数据条数" class="headerlink" title="获取每个表的数据条数"></a>获取每个表的数据条数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select schema_name(t.schema_id) as [Schema], t.name as TableName,i.rows as [RowCount] </span><br><span class="line">from sys.tables as t, sysindexes as i </span><br><span class="line">where t.object_id &#x3D; i.id and i.indid &lt;&#x3D;1</span><br></pre></td></tr></table></figure>
<h4 id="按rownumber删除"><a href="#按rownumber删除" class="headerlink" title="按rownumber删除"></a>按rownumber删除</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; with cte(rownum)as(</span><br><span class="line">    select row_number () over(partition by [Col1], [Col2] order by Col3) from [table]</span><br><span class="line">)</span><br><span class="line">delete from cte where rownum &gt; 1</span><br></pre></td></tr></table></figure>
<p>按Col1 Col2分组删除 保留组唯一</p>
<h4 id="login-fail-Error-18456"><a href="#login-fail-Error-18456" class="headerlink" title="login fail Error 18456"></a>login fail Error 18456</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/mo_feng_/article/details/62226310">CSDN Blog:SQL Server Error 18456</a></p>
<p>other issues: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/sql/database-engine/configure-windows/troubleshoot-connecting-to-the-sql-server-database-engine?view=sql-server-ver15#enable-protocols">Microsoft Docs: Troubleshooting Connect to SQL Server</a></p>
<h4 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select @@version</span><br></pre></td></tr></table></figure>
<h4 id="作业和代理"><a href="#作业和代理" class="headerlink" title="作业和代理"></a>作业和代理</h4><p><del>某需求欲使用SQL Server的计划进行自动备份，启动SQL Server Agent时账户密码不正确 且该账号登录SSMS没有计划、代理等菜单</del></p>
<p>SQL Server Express没有这部分功能</p>
<h4 id="sqlcmd"><a href="#sqlcmd" class="headerlink" title="sqlcmd"></a>sqlcmd</h4>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/qqsnote/page/20/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/qqsnote/">1</a><span class="space">&hellip;</span><a class="page-number" href="/qqsnote/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/qqsnote/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/qqsnote/page/34/">34</a><a class="extend next" rel="next" href="/qqsnote/page/22/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">QQs</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/qqsnote/archives/">
        
          <span class="site-state-item-count">336</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/qqsnote/categories/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/qqsnote/tags/">
        <span class="site-state-item-count">128</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

      <div class="tag-cloud-tags">
        <a href="/qqsnote/tags/Net/" style="font-size: 30px; color: #fff">.Net</a> <a href="/qqsnote/tags/4G/" style="font-size: 12px; color: #ccc">4G</a> <a href="/qqsnote/tags/AI/" style="font-size: 22.5px; color: #eaeaea">AI</a> <a href="/qqsnote/tags/Android/" style="font-size: 12px; color: #ccc">Android</a> <a href="/qqsnote/tags/Angular/" style="font-size: 30px; color: #fff">Angular</a> <a href="/qqsnote/tags/Apache/" style="font-size: 13.5px; color: #d0d0d0">Apache</a> <a href="/qqsnote/tags/Azure/" style="font-size: 25.5px; color: #f2f2f2">Azure</a> <a href="/qqsnote/tags/Babylon/" style="font-size: 12px; color: #ccc">Babylon</a> <a href="/qqsnote/tags/C/" style="font-size: 16.5px; color: #d9d9d9">C#</a> <a href="/qqsnote/tags/C/" style="font-size: 16.5px; color: #d9d9d9">C++</a> <a href="/qqsnote/tags/CSS/" style="font-size: 19.5px; color: #e1e1e1">CSS</a> <a href="/qqsnote/tags/DevOps/" style="font-size: 15px; color: #d5d5d5">DevOps</a> <a href="/qqsnote/tags/Docker/" style="font-size: 16.5px; color: #d9d9d9">Docker</a> <a href="/qqsnote/tags/ES6/" style="font-size: 12px; color: #ccc">ES6</a> <a href="/qqsnote/tags/ESLint/" style="font-size: 12px; color: #ccc">ESLint</a> <a href="/qqsnote/tags/ElasticSearch/" style="font-size: 12px; color: #ccc">ElasticSearch</a> <a href="/qqsnote/tags/Electron/" style="font-size: 16.5px; color: #d9d9d9">Electron</a> <a href="/qqsnote/tags/ElementUI/" style="font-size: 12px; color: #ccc">ElementUI</a> <a href="/qqsnote/tags/EntityFramework/" style="font-size: 13.5px; color: #d0d0d0">EntityFramework</a> <a href="/qqsnote/tags/EventBus/" style="font-size: 12px; color: #ccc">EventBus</a> <a href="/qqsnote/tags/Excel/" style="font-size: 12px; color: #ccc">Excel</a> <a href="/qqsnote/tags/FastDFS/" style="font-size: 12px; color: #ccc">FastDFS</a> <a href="/qqsnote/tags/Figma/" style="font-size: 12px; color: #ccc">Figma</a> <a href="/qqsnote/tags/Go/" style="font-size: 12px; color: #ccc">Go</a> <a href="/qqsnote/tags/GraphQL/" style="font-size: 12px; color: #ccc">GraphQL</a> <a href="/qqsnote/tags/Jasmine/" style="font-size: 12px; color: #ccc">Jasmine</a> <a href="/qqsnote/tags/Java/" style="font-size: 13.5px; color: #d0d0d0">Java</a> <a href="/qqsnote/tags/Jenkins/" style="font-size: 21px; color: #e6e6e6">Jenkins</a> <a href="/qqsnote/tags/Linux/" style="font-size: 22.5px; color: #eaeaea">Linux</a> <a href="/qqsnote/tags/MQ/" style="font-size: 12px; color: #ccc">MQ</a> <a href="/qqsnote/tags/Markdown/" style="font-size: 13.5px; color: #d0d0d0">Markdown</a> <a href="/qqsnote/tags/MongoDB/" style="font-size: 12px; color: #ccc">MongoDB</a> <a href="/qqsnote/tags/Monorepo/" style="font-size: 12px; color: #ccc">Monorepo</a> <a href="/qqsnote/tags/MySQL/" style="font-size: 12px; color: #ccc">MySQL</a> <a href="/qqsnote/tags/NSIS/" style="font-size: 12px; color: #ccc">NSIS</a> <a href="/qqsnote/tags/Nginx/" style="font-size: 12px; color: #ccc">Nginx</a> <a href="/qqsnote/tags/NoSQL/" style="font-size: 12px; color: #ccc">NoSQL</a> <a href="/qqsnote/tags/Node-js/" style="font-size: 18px; color: #ddd">Node.js</a> <a href="/qqsnote/tags/OData/" style="font-size: 13.5px; color: #d0d0d0">OData</a> <a href="/qqsnote/tags/OpenCV/" style="font-size: 18px; color: #ddd">OpenCV</a> <a href="/qqsnote/tags/OpenGL/" style="font-size: 13.5px; color: #d0d0d0">OpenGL</a> <a href="/qqsnote/tags/PHP/" style="font-size: 12px; color: #ccc">PHP</a> <a href="/qqsnote/tags/PWA/" style="font-size: 12px; color: #ccc">PWA</a> <a href="/qqsnote/tags/PyCharm/" style="font-size: 12px; color: #ccc">PyCharm</a> <a href="/qqsnote/tags/Python/" style="font-size: 24px; color: #eee">Python</a> <a href="/qqsnote/tags/R3F/" style="font-size: 12px; color: #ccc">R3F</a> <a href="/qqsnote/tags/React/" style="font-size: 21px; color: #e6e6e6">React</a> <a href="/qqsnote/tags/SQL/" style="font-size: 12px; color: #ccc">SQL</a> <a href="/qqsnote/tags/SQL-Server/" style="font-size: 15px; color: #d5d5d5">SQL_Server</a> <a href="/qqsnote/tags/ServiceWorker/" style="font-size: 12px; color: #ccc">ServiceWorker</a> <a href="/qqsnote/tags/Shell/" style="font-size: 12px; color: #ccc">Shell</a> <a href="/qqsnote/tags/Three-js/" style="font-size: 16.5px; color: #d9d9d9">Three.js</a> <a href="/qqsnote/tags/TypeScript/" style="font-size: 13.5px; color: #d0d0d0">TypeScript</a> <a href="/qqsnote/tags/UE/" style="font-size: 12px; color: #ccc">UE</a> <a href="/qqsnote/tags/UI/" style="font-size: 12px; color: #ccc">UI</a> <a href="/qqsnote/tags/UML/" style="font-size: 12px; color: #ccc">UML</a> <a href="/qqsnote/tags/Virtualbox/" style="font-size: 12px; color: #ccc">Virtualbox</a> <a href="/qqsnote/tags/WPF/" style="font-size: 12px; color: #ccc">WPF</a> <a href="/qqsnote/tags/WebGL/" style="font-size: 21px; color: #e6e6e6">WebGL</a> <a href="/qqsnote/tags/WebService/" style="font-size: 12px; color: #ccc">WebService</a> <a href="/qqsnote/tags/Web%E5%8D%8F%E8%AE%AE/" style="font-size: 12px; color: #ccc">Web协议</a> <a href="/qqsnote/tags/Web%E5%BC%80%E5%8F%91/" style="font-size: 27px; color: #f7f7f7">Web开发</a> <a href="/qqsnote/tags/Wechat/" style="font-size: 12px; color: #ccc">Wechat</a> <a href="/qqsnote/tags/aigc/" style="font-size: 12px; color: #ccc">aigc</a> <a href="/qqsnote/tags/auth/" style="font-size: 12px; color: #ccc">auth</a> <a href="/qqsnote/tags/axios/" style="font-size: 12px; color: #ccc">axios</a> <a href="/qqsnote/tags/canvas/" style="font-size: 12px; color: #ccc">canvas</a> <a href="/qqsnote/tags/css/" style="font-size: 12px; color: #ccc">css</a> <a href="/qqsnote/tags/express/" style="font-size: 12px; color: #ccc">express</a> <a href="/qqsnote/tags/ftp/" style="font-size: 12px; color: #ccc">ftp</a> <a href="/qqsnote/tags/git/" style="font-size: 13.5px; color: #d0d0d0">git</a> <a href="/qqsnote/tags/hexo/" style="font-size: 12px; color: #ccc">hexo</a> <a href="/qqsnote/tags/http/" style="font-size: 12px; color: #ccc">http</a> <a href="/qqsnote/tags/http2/" style="font-size: 12px; color: #ccc">http2</a> <a href="/qqsnote/tags/https/" style="font-size: 12px; color: #ccc">https</a> <a href="/qqsnote/tags/ionic/" style="font-size: 12px; color: #ccc">ionic</a> <a href="/qqsnote/tags/javascript/" style="font-size: 28.5px; color: #fbfbfb">javascript</a> <a href="/qqsnote/tags/k8s/" style="font-size: 12px; color: #ccc">k8s</a> <a href="/qqsnote/tags/login/" style="font-size: 12px; color: #ccc">login</a> <a href="/qqsnote/tags/loopback/" style="font-size: 12px; color: #ccc">loopback</a> <a href="/qqsnote/tags/ngrok/" style="font-size: 12px; color: #ccc">ngrok</a> <a href="/qqsnote/tags/npm/" style="font-size: 12px; color: #ccc">npm</a> <a href="/qqsnote/tags/nsis/" style="font-size: 13.5px; color: #d0d0d0">nsis</a> <a href="/qqsnote/tags/redis/" style="font-size: 12px; color: #ccc">redis</a> <a href="/qqsnote/tags/sqlServer/" style="font-size: 12px; color: #ccc">sqlServer</a> <a href="/qqsnote/tags/ssh/" style="font-size: 12px; color: #ccc">ssh</a> <a href="/qqsnote/tags/svg/" style="font-size: 12px; color: #ccc">svg</a> <a href="/qqsnote/tags/trea/" style="font-size: 12px; color: #ccc">trea</a> <a href="/qqsnote/tags/vtk/" style="font-size: 16.5px; color: #d9d9d9">vtk</a> <a href="/qqsnote/tags/vuejs/" style="font-size: 19.5px; color: #e1e1e1">vuejs</a> <a href="/qqsnote/tags/webassembly/" style="font-size: 15px; color: #d5d5d5">webassembly</a> <a href="/qqsnote/tags/webpack/" style="font-size: 12px; color: #ccc">webpack</a> <a href="/qqsnote/tags/websocket/" style="font-size: 12px; color: #ccc">websocket</a> <a href="/qqsnote/tags/windows/" style="font-size: 12px; color: #ccc">windows</a> <a href="/qqsnote/tags/yarn/" style="font-size: 12px; color: #ccc">yarn</a> <a href="/qqsnote/tags/%E4%B8%8A%E4%BC%A0/" style="font-size: 12px; color: #ccc">上传</a> <a href="/qqsnote/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" style="font-size: 12px; color: #ccc">内网穿透</a> <a href="/qqsnote/tags/%E5%8A%A0%E5%AF%86/" style="font-size: 16.5px; color: #d9d9d9">加密</a> <a href="/qqsnote/tags/%E5%8C%BB%E5%AD%A6%E5%9B%BE%E5%83%8F/" style="font-size: 13.5px; color: #d0d0d0">医学图像</a> <a href="/qqsnote/tags/%E5%8D%9A%E5%BC%88%E8%AE%BA/" style="font-size: 12px; color: #ccc">博弈论</a> <a href="/qqsnote/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 12px; color: #ccc">图像处理</a> <a href="/qqsnote/tags/%E5%9B%BE%E5%BD%A2%E5%AD%A6/" style="font-size: 18px; color: #ddd">图形学</a> <a href="/qqsnote/tags/%E5%A4%9A%E8%AF%AD%E8%A8%80/" style="font-size: 13.5px; color: #d0d0d0">多语言</a> <a href="/qqsnote/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B/" style="font-size: 12px; color: #ccc">大模型</a> <a href="/qqsnote/tags/%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B/" style="font-size: 12px; color: #ccc">存储过程</a> <a href="/qqsnote/tags/%E6%80%A7%E8%83%BD/" style="font-size: 15px; color: #d5d5d5">性能</a> <a href="/qqsnote/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 13.5px; color: #d0d0d0">性能优化</a> <a href="/qqsnote/tags/%E6%88%90%E9%95%BF%E6%80%9D%E7%BB%B4/" style="font-size: 12px; color: #ccc">成长思维</a> <a href="/qqsnote/tags/%E6%91%84%E5%BD%B1/" style="font-size: 12px; color: #ccc">摄影</a> <a href="/qqsnote/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 12px; color: #ccc">操作系统</a> <a href="/qqsnote/tags/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/" style="font-size: 12px; color: #ccc">数字签名</a> <a href="/qqsnote/tags/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/" style="font-size: 12px; color: #ccc">数据可视化</a> <a href="/qqsnote/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%94%81/" style="font-size: 12px; color: #ccc">数据库锁</a> <a href="/qqsnote/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 12px; color: #ccc">树莓派</a> <a href="/qqsnote/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 12px; color: #ccc">正则表达式</a> <a href="/qqsnote/tags/%E7%89%A9%E8%81%94%E7%BD%91/" style="font-size: 12px; color: #ccc">物联网</a> <a href="/qqsnote/tags/%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/" style="font-size: 13.5px; color: #d0d0d0">环境变量</a> <a href="/qqsnote/tags/%E7%AE%97%E6%B3%95/" style="font-size: 16.5px; color: #d9d9d9">算法</a> <a href="/qqsnote/tags/%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 12px; color: #ccc">编码规范</a> <a href="/qqsnote/tags/%E8%8B%B1%E8%AF%AD/" style="font-size: 12px; color: #ccc">英语</a> <a href="/qqsnote/tags/%E8%A7%86%E9%A2%91%E6%B5%81/" style="font-size: 12px; color: #ccc">视频流</a> <a href="/qqsnote/tags/%E8%A7%A6%E5%8F%91%E5%99%A8/" style="font-size: 12px; color: #ccc">触发器</a> <a href="/qqsnote/tags/%E8%AE%A4%E8%AF%81-%E6%8E%88%E6%9D%83/" style="font-size: 21px; color: #e6e6e6">认证&授权</a> <a href="/qqsnote/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 12px; color: #ccc">设计模式</a> <a href="/qqsnote/tags/%E8%AF%BB%E4%B9%A6/" style="font-size: 12px; color: #ccc">读书</a> <a href="/qqsnote/tags/%E8%BF%9B%E7%A8%8B%E5%AE%88%E6%8A%A4/" style="font-size: 12px; color: #ccc">进程守护</a> <a href="/qqsnote/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 13.5px; color: #d0d0d0">面试</a> <a href="/qqsnote/tags/%E9%A6%99%E6%A9%99%E6%B4%BE/" style="font-size: 12px; color: #ccc">香橙派</a>
      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">QQs</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/qqsnote/lib/anime.min.js"></script>
  <script src="/qqsnote/lib/velocity/velocity.min.js"></script>
  <script src="/qqsnote/lib/velocity/velocity.ui.min.js"></script>

<script src="/qqsnote/js/utils.js"></script>

<script src="/qqsnote/js/motion.js"></script>


<script src="/qqsnote/js/schemes/muse.js"></script>


<script src="/qqsnote/js/next-boot.js"></script>




  




  
<script src="/qqsnote/js/local-search.js"></script>













  

  

  

</body>
</html>
